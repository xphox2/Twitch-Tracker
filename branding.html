<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Modular Branding Settings</title>
    <link id="google-font-link" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 30px;
            color: #fff;
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #a0aec0;
            margin-bottom: 30px;
        }

        .container {
            display: grid;
            grid-template-columns: 480px 1fr;
            gap: 30px;
            max-width: 1700px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel h2 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-group {
            margin-bottom: 16px;
        }

        .control-group label {
            display: block;
            font-size: 12px;
            color: #a0aec0;
            margin-bottom: 6px;
        }

        .color-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-input-wrapper input[type="text"] {
            display: none;
        }

        input[type="color"] {
            width: 50px;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: transparent;
        }

        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 2px;
        }

        input[type="color"]::-webkit-color-swatch {
            border-radius: 4px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        input[type="text"] {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 8px 10px;
            color: #fff;
            font-size: 13px;
            font-family: monospace;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #9146ff;
        }

        input[type="range"] {
            width: 100%;
            height: 5px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            appearance: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #9146ff;
            cursor: pointer;
            transition: transform 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .range-value {
            text-align: right;
            font-size: 11px;
            color: #a0aec0;
            margin-top: 4px;
        }

        select {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 8px 10px;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: #9146ff;
        }

        option {
            background: #1a1a2e;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #9146ff;
            color: #fff;
        }

        .btn-primary:hover {
            background: #7c3aed;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .preview-section {
            position: sticky;
            top: 30px;
        }

        .preview-box {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            min-height: 400px;
        }

        .status-message {
            margin-top: 15px;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 13px;
            display: none;
        }

        .status-message.success {
            background: rgba(72, 187, 120, 0.2);
            color: #48bb78;
            display: block;
        }

        .status-message.error {
            background: rgba(245, 101, 101, 0.2);
            color: #f56565;
            display: block;
        }

        .section-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 20px 0;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #9146ff;
        }

        .checkbox-wrapper label {
            margin: 0;
            cursor: pointer;
            font-size: 13px;
        }

        .font-preview {
            margin-top: 10px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-size: 24px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-box {
            background: rgba(145, 70, 255, 0.1);
            border: 1px solid rgba(145, 70, 255, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 12px;
            color: #a0aec0;
        }

        .info-box strong {
            color: #fff;
        }

        /* Widget-specific control panels */
        .widget-section {
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .widget-section.collapsed .widget-content {
            display: none;
        }

        .widget-section.disabled {
            opacity: 0.5;
        }

        .widget-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }

        .widget-header h3 {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }

        .widget-header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            width: 40px;
            height: 22px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transition: .3s;
            border-radius: 22px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #9146ff;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(18px);
        }

        .collapse-icon {
            font-size: 18px;
            transition: transform 0.2s;
            color: #a0aec0;
        }

        .widget-section.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .widget-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .widget-content {
            margin-top: 15px;
        }

        .control-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .control-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }

        .control-row-4 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 10px;
        }

        .control-small label {
            font-size: 11px;
        }

        /* Preview Styles */
        .sidebar2-preview {
            display: flex;
            flex-direction: column;
            gap: var(--preview-gap, 5px);
            max-width: 280px;
            font-family: var(--preview-font-family, 'Bebas Neue', sans-serif);
        }

        .preview-widget {
            min-width: 180px;
            text-align: center;
            display: flex;
            flex-direction: column;
            opacity: 1;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
        }

        .preview-widget:active {
            cursor: grabbing;
        }

        .preview-widget.dragging {
            opacity: 0.5;
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .preview-widget.drag-over {
            transform: translateY(5px);
        }

        .preview-widget.hidden {
            display: none;
        }

        .preview-widget.followers {
            background: var(--followers-bg, rgba(0,0,0,0));
            border-radius: var(--followers-radius, 0);
            padding: var(--followers-padding, 8px 15px);
            border: var(--followers-border-width, 2px) var(--followers-border-style, solid) var(--followers-border-color, #9146ff);
        }

        .preview-widget.followers .preview-value {
            margin-top: var(--followers-label-gap, 5px);
            color: var(--followers-text, #9146ff);
            font-size: var(--followers-size, 48px);
            text-shadow: var(--followers-text-shadow, 2px 2px 4px rgba(0,0,0,0.8));
        }

        .preview-widget.followers .preview-label {
            color: var(--followers-label, #aaaaaa);
            font-size: var(--followers-label-size, 14px);
            text-shadow: var(--followers-text-shadow, 2px 2px 4px rgba(0,0,0,0.8));
        }

        .preview-widget.subgoal {
            background: var(--subgoal-bg, rgba(0,0,0,0));
            border-radius: var(--subgoal-radius, 0);
            padding: var(--subgoal-padding, 8px 15px);
            border: var(--subgoal-border-width, 2px) var(--subgoal-border-style, solid) var(--subgoal-border-color, #00d2d3);
        }

        .preview-widget.subgoal .preview-value {
            margin-top: var(--subgoal-label-gap, 5px);
            color: var(--subgoal-text, #00d2d3);
            font-size: var(--subgoal-size, 42px);
            text-shadow: var(--subgoal-text-shadow, 2px 2px 4px rgba(0,0,0,0.8));
        }

        .preview-widget.subgoal .preview-label {
            color: var(--subgoal-label, #aaaaaa);
            font-size: var(--subgoal-label-size, 14px);
            text-shadow: var(--subgoal-text-shadow, 2px 2px 4px rgba(0,0,0,0.8));
        }

        .preview-widget.bits {
            background: var(--bits-bg, rgba(0,0,0,0));
            border-radius: var(--bits-radius, 0);
            padding: var(--bits-padding, 8px 15px);
            border: var(--bits-border-width, 2px) var(--bits-border-style, solid) var(--bits-border-color, #2ed573);
        }

        .preview-widget.bits .preview-value {
            margin-top: var(--bits-label-gap, 5px);
            color: var(--bits-text, #2ed573);
            font-size: var(--bits-size, 42px);
            text-shadow: var(--bits-text-shadow, 2px 2px 4px rgba(0,0,0,0.8));
        }

        .preview-widget.bits .preview-label {
            color: var(--bits-label, #aaaaaa);
            font-size: var(--bits-label-size, 14px);
            text-shadow: var(--bits-text-shadow, 2px 2px 4px rgba(0,0,0,0.8));
        }

        .preview-widget.monthly {
            background: var(--monthly-bg, rgba(0,0,0,0));
            border-radius: var(--monthly-radius, 0);
            padding: var(--monthly-padding, 8px 15px);
            border: var(--monthly-border-width, 2px) var(--monthly-border-style, solid) var(--monthly-border-color, #ff6b6b);
        }

        .preview-widget.monthly .preview-value {
            margin-top: var(--monthly-label-gap, 5px);
            color: var(--monthly-text, #ff6b6b);
            font-size: var(--monthly-size, 42px);
            text-shadow: var(--monthly-text-shadow, 2px 2px 4px rgba(0,0,0,0.8));
        }

        .preview-widget.monthly .preview-label {
            color: var(--monthly-label, #aaaaaa);
            font-size: var(--monthly-label-size, 14px);
            text-shadow: var(--monthly-text-shadow, 2px 2px 4px rgba(0,0,0,0.8));
        }

        .preview-widget.lifetime {
            background: var(--lifetime-bg, rgba(0,0,0,0));
            border-radius: var(--lifetime-radius, 0);
            padding: var(--lifetime-padding, 8px 15px);
            border: var(--lifetime-border-width, 2px) var(--lifetime-border-style, solid) var(--lifetime-border-color, #ffd700);
        }

        .preview-widget.lifetime .preview-value {
            margin-top: var(--lifetime-label-gap, 5px);
            color: var(--lifetime-text, #ffd700);
            font-size: var(--lifetime-size, 36px);
            text-shadow: var(--lifetime-text-shadow, 2px 2px 4px rgba(0,0,0,0.8));
        }

        .preview-widget.lifetime .preview-label {
            color: var(--lifetime-label, #aaaaaa);
            font-size: var(--lifetime-label-size, 14px);
            text-shadow: var(--lifetime-text-shadow, 2px 2px 4px rgba(0,0,0,0.8));
        }

        .preview-widget.hours {
            background: var(--hours-bg, rgba(0,0,0,0));
            border-radius: var(--hours-radius, 0);
            padding: var(--hours-padding, 8px 15px);
            border: var(--hours-border-width, 2px) var(--hours-border-style, solid) var(--hours-border-color, #00bcd4);
        }

        .preview-widget.hours .preview-value {
            margin-top: var(--hours-label-gap, 5px);
            color: var(--hours-text, #00bcd4);
            font-size: var(--hours-size, 42px);
            text-shadow: var(--hours-text-shadow, 2px 2px 4px rgba(0,0,0,0.8));
        }

        .preview-widget.hours .preview-label {
            color: var(--hours-label, #aaaaaa);
            font-size: var(--hours-label-size, 14px);
            text-shadow: var(--hours-text-shadow, 2px 2px 4px rgba(0,0,0,0.8));
        }

        .preview-label, .preview-value {
            font-weight: bold;
            opacity: 1 !important;
            line-height: 1;
        }

        .preview-label {
            text-transform: uppercase;
        }

        .scrollable-panel {
            max-height: 85vh;
            overflow-y: auto;
            padding-right: 10px;
        }

        .scrollable-panel::-webkit-scrollbar {
            width: 8px;
        }

        .scrollable-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .scrollable-panel::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .scrollable-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .button-row {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Sticky Save Buttons */
        .sticky-buttons {
            position: sticky;
            bottom: 0;
            background: linear-gradient(to top, rgba(26, 26, 46, 1) 0%, rgba(26, 26, 46, 0.98) 70%, rgba(26, 26, 46, 0) 100%);
            padding: 20px 0 10px 0;
            margin-top: 20px;
            z-index: 100;
        }

        .sticky-buttons .button-row {
            margin-top: 0;
            background: rgba(26, 26, 46, 0.95);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(145, 70, 255, 0.3);
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.3);
        }

        .sticky-buttons .btn-primary {
            flex: 1;
            padding: 12px 20px;
            font-size: 14px;
        }

        .sticky-buttons .btn-secondary {
            padding: 12px 20px;
            font-size: 14px;
        }

        .drag-hint {
            text-align: center;
            color: #666;
            font-size: 11px;
            margin-top: 15px;
            padding: 10px;
            border: 1px dashed rgba(255,255,255,0.2);
            border-radius: 8px;
        }

        .text-shadow-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .shadow-preset {
            padding: 6px 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            color: #a0aec0;
            transition: all 0.2s;
        }

        .shadow-preset:hover {
            background: rgba(255,255,255,0.1);
            border-color: #9146ff;
        }

        .shadow-preset.active {
            background: rgba(145, 70, 255, 0.3);
            border-color: #9146ff;
            color: #fff;
        }

        .border-style-options {
            display: flex;
            gap: 6px;
        }

        .border-style-btn {
            padding: 6px 10px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            color: #a0aec0;
            transition: all 0.2s;
        }

        .border-style-btn:hover {
            border-color: #9146ff;
        }

        .border-style-btn.active {
            background: rgba(145, 70, 255, 0.3);
            border-color: #9146ff;
            color: #fff;
        }

        /* Preset Theme Styles */
        .preset-section {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .preset-section label {
            display: block;
            font-size: 12px;
            color: #a0aec0;
            margin-bottom: 8px;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        .preset-btn {
            padding: 8px 4px;
            background: rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            cursor: pointer;
            font-size: 10px;
            color: #a0aec0;
            transition: all 0.2s;
            text-align: center;
            position: relative;
        }

        .preset-btn:hover {
            border-color: rgba(255,255,255,0.3);
            transform: scale(1.02);
        }

        .preset-btn.active {
            border-color: #9146ff;
            background: rgba(145, 70, 255, 0.2);
            color: #fff;
        }

        .preset-preview {
            width: 100%;
            height: 20px;
            border-radius: 4px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: bold;
        }

        .saved-presets-section {
            margin-top: 20px;
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .saved-presets-section h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .save-preset-row {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .save-preset-row input {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 8px 10px;
            color: #fff;
            font-size: 13px;
        }

        .save-preset-row input:focus {
            outline: none;
            border-color: #9146ff;
        }

        .saved-preset-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 200px;
            overflow-y: auto;
        }

        .saved-preset-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .saved-preset-item:hover {
            border-color: rgba(255,255,255,0.2);
        }

        .saved-preset-name {
            font-size: 12px;
            color: #fff;
        }

        .saved-preset-actions {
            display: flex;
            gap: 6px;
        }

        .saved-preset-actions button {
            padding: 4px 8px;
            font-size: 10px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: #a0aec0;
            transition: all 0.2s;
        }

        .saved-preset-actions button:hover {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        .saved-preset-actions button.delete:hover {
            background: rgba(255, 100, 100, 0.3);
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        /* Preset Editor Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            padding: 24px;
            width: 400px;
            max-width: 90vw;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal h3 {
            font-size: 18px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-preview {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .modal-preview-box {
            padding: 15px 30px;
            border-radius: 8px;
            text-align: center;
        }

        .modal-preview-box .preview-text {
            font-size: 36px;
            font-weight: bold;
        }

        .modal-preview-box .preview-label {
            font-size: 12px;
            margin-top: 5px;
        }

        .modal-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }

        .modal-row-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }

        .modal-group label {
            display: block;
            font-size: 11px;
            color: #a0aec0;
            margin-bottom: 4px;
        }

        .modal-group input[type="color"] {
            width: 100%;
            height: 36px;
        }

        .modal-group input[type="text"] {
            width: 100%;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #fff;
            font-size: 13px;
        }

        .modal-group select {
            width: 100%;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #fff;
            font-size: 13px;
        }

        .modal-group input[type="number"] {
            width: 100%;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #fff;
            font-size: 13px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .modal-buttons button {
            padding: 10px 20px;
        }

        /* Widget Groups Styles */
        .widget-groups-section {
            margin-top: 20px;
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .widget-groups-section h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .widget-groups-section p {
            font-size: 11px;
            color: #666;
            margin-bottom: 12px;
        }

        .group-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 12px;
        }

        .group-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
        }

        .group-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .group-item-name {
            font-size: 13px;
            font-weight: 600;
            color: #fff;
        }

        .group-item-actions {
            display: flex;
            gap: 6px;
        }

        .group-item-actions button {
            padding: 4px 8px;
            font-size: 10px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: #a0aec0;
            transition: all 0.2s;
        }

        .group-item-actions button:hover {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        .group-item-widgets {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }

        .group-widget-tag {
            padding: 4px 10px;
            background: rgba(145, 70, 255, 0.2);
            border: 1px solid rgba(145, 70, 255, 0.4);
            border-radius: 12px;
            font-size: 11px;
            color: #bb99ff;
        }

        .group-item-settings {
            display: flex;
            gap: 15px;
            font-size: 11px;
            color: #888;
        }

        .group-item-settings span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Group Editor Modal */
        .group-modal {
            width: 450px;
        }

        .widget-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .widget-selector-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .widget-selector-item:hover {
            border-color: rgba(255, 255, 255, 0.3);
        }

        .widget-selector-item.selected {
            border-color: #9146ff;
            background: rgba(145, 70, 255, 0.2);
        }

        .widget-selector-item.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .widget-selector-item input {
            display: none;
        }

        .widget-selector-item .checkmark {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: transparent;
            transition: all 0.2s;
        }

        .widget-selector-item.selected .checkmark {
            background: #9146ff;
            border-color: #9146ff;
            color: #fff;
        }

        .widget-selector-item .widget-label {
            font-size: 12px;
            color: #fff;
        }

        .group-settings-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        /* Preview animation for groups */
        .preview-widget-group {
            position: relative;
            overflow: hidden;
            min-height: 80px;
        }

        .preview-widget-group .preview-widget {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease-in-out;
        }

        .preview-widget-group .preview-widget.group-active {
            position: relative;
            opacity: 1;
            pointer-events: auto;
        }

        /* Fade animation (default) */
        .preview-widget-group.fade .preview-widget {
            transition: opacity 0.5s ease-in-out;
        }

        /* Slide Up animation */
        .preview-widget-group.slide-up .preview-widget {
            transform: translateY(30px);
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        }

        .preview-widget-group.slide-up .preview-widget.group-active {
            transform: translateY(0);
        }

        /* Slide Down animation */
        .preview-widget-group.slide-down .preview-widget {
            transform: translateY(-30px);
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        }

        .preview-widget-group.slide-down .preview-widget.group-active {
            transform: translateY(0);
        }

        /* Instant animation (no transition) */
        .preview-widget-group.instant .preview-widget {
            transition: none;
        }

        .group-indicator {
            position: absolute;
            top: -12px;
            right: -5px;
            padding: 2px 8px;
            background: rgba(145, 70, 255, 0.9);
            border-radius: 10px;
            font-size: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 500;
            border: 1px solid rgba(255,255,255,0.2);
            white-space: nowrap;
            z-index: 10;
        }

        .no-groups-message {
            font-size: 12px;
            color: #666;
            text-align: center;
            padding: 15px;
            font-style: italic;
        }

        .no-groups-message {
            text-align: center;
            padding: 15px;
            color: #666;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- Preset Editor Modal -->
    <div class="modal-overlay" id="preset-modal">
        <div class="modal">
            <h3 id="modal-title">Edit Preset</h3>

            <div class="modal-preview">
                <div class="modal-preview-box" id="modal-preview-box">
                    <div class="preview-text">123</div>
                    <div class="preview-label">SAMPLE</div>
                </div>
            </div>

            <div class="modal-group" style="margin-bottom: 15px;">
                <label>Preset Name</label>
                <input type="text" id="modal-preset-name" placeholder="My Custom Preset">
            </div>

            <div class="modal-row">
                <div class="modal-group">
                    <label>Text Color</label>
                    <input type="color" id="modal-text-color" value="#9146ff">
                </div>
                <div class="modal-group">
                    <label>Label Color</label>
                    <input type="color" id="modal-label-color" value="#aaaaaa">
                </div>
                <div class="modal-group">
                    <label>Border Color</label>
                    <input type="color" id="modal-border-color" value="#9146ff">
                </div>
            </div>

            <div class="modal-row">
                <div class="modal-group">
                    <label>Border Width</label>
                    <input type="number" id="modal-border-width" min="0" max="10" value="2">
                </div>
                <div class="modal-group">
                    <label>Border Style</label>
                    <select id="modal-border-style">
                        <option value="solid">Solid</option>
                        <option value="dashed">Dashed</option>
                        <option value="dotted">Dotted</option>
                        <option value="double">Double</option>
                        <option value="none">None</option>
                    </select>
                </div>
                <div class="modal-group">
                    <label>Border Radius</label>
                    <input type="number" id="modal-border-radius" min="0" max="30" value="0">
                </div>
            </div>

            <div class="modal-group">
                <label>Text Shadow</label>
                <select id="modal-text-shadow">
                    <option value="2px 2px 4px rgba(0,0,0,0.8)">Default Shadow</option>
                    <option value="none">None</option>
                    <option value="0 0 10px currentColor">Glow (uses text color)</option>
                    <option value="3px 3px 0 rgba(0,0,0,0.5)">Hard Shadow</option>
                    <option value="0 0 20px currentColor">Strong Glow</option>
                </select>
            </div>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closePresetModal()">Cancel</button>
                <button class="btn btn-primary" id="modal-save-btn" onclick="savePresetFromModal()">Save Preset</button>
            </div>
        </div>
    </div>

    <!-- Widget Group Editor Modal -->
    <div class="modal-overlay" id="group-modal">
        <div class="modal group-modal">
            <h3 id="group-modal-title">Create Widget Group</h3>

            <div class="modal-group" style="margin-bottom: 15px;">
                <label>Group Name</label>
                <input type="text" id="group-name" placeholder="e.g., Stats Rotation">
            </div>

            <div class="modal-group" style="margin-bottom: 15px;">
                <label>Select Widgets to Rotate (pick 2 or more)</label>
                <div class="widget-selector" id="widget-selector">
                    <!-- Populated by JS -->
                </div>
            </div>

            <div class="group-settings-row">
                <div class="modal-group">
                    <label>Rotation Interval</label>
                    <select id="group-interval">
                        <option value="5">5 seconds</option>
                        <option value="10" selected>10 seconds</option>
                        <option value="15">15 seconds</option>
                        <option value="20">20 seconds</option>
                        <option value="30">30 seconds</option>
                        <option value="45">45 seconds</option>
                        <option value="60">60 seconds</option>
                    </select>
                </div>
                <div class="modal-group">
                    <label>Animation Style</label>
                    <select id="group-animation">
                        <option value="fade">Fade</option>
                        <option value="slide-up">Slide Up</option>
                        <option value="slide-down">Slide Down</option>
                        <option value="instant">Instant (no animation)</option>
                    </select>
                </div>
            </div>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeGroupModal()">Cancel</button>
                <button class="btn btn-primary" id="group-save-btn" onclick="saveGroupFromModal()">Create Group</button>
            </div>
        </div>
    </div>

    <h1>Modular Branding Settings</h1>
    <p class="subtitle">Drag widgets to reorder, toggle visibility, and customize each independently</p>

    <div class="container">
        <div class="controls scrollable-panel">
            <div class="panel">
                <div class="info-box">
                    <strong>Tips:</strong> Click presets to apply. <strong>Right-click</strong> built-in presets to copy and customize them. Create your own presets below. Your settings are auto-backed up.
                </div>

                <h2>Global Typography</h2>

                <div class="control-group">
                    <label>Font Family (Google Fonts)</label>
                    <select id="font-family">
                        <optgroup label="Popular Display Fonts">
                            <option value="Bebas Neue">Bebas Neue</option>
                            <option value="Oswald">Oswald</option>
                            <option value="Montserrat">Montserrat</option>
                            <option value="Poppins">Poppins</option>
                            <option value="Roboto">Roboto</option>
                            <option value="Open Sans">Open Sans</option>
                        </optgroup>
                        <optgroup label="Gaming/Modern">
                            <option value="Orbitron">Orbitron</option>
                            <option value="Russo One">Russo One</option>
                            <option value="Black Ops One">Black Ops One</option>
                            <option value="Press Start 2P">Press Start 2P</option>
                            <option value="Bungee">Bungee</option>
                        </optgroup>
                        <optgroup label="Elegant/Professional">
                            <option value="Playfair Display">Playfair Display</option>
                            <option value="Lato">Lato</option>
                            <option value="Raleway">Raleway</option>
                            <option value="Nunito">Nunito</option>
                            <option value="Work Sans">Work Sans</option>
                        </optgroup>
                        <optgroup label="Fun/Unique">
                            <option value="Lobster">Lobster</option>
                            <option value="Pacifico">Pacifico</option>
                            <option value="Permanent Marker">Permanent Marker</option>
                            <option value="Righteous">Righteous</option>
                            <option value="Fredoka One">Fredoka One</option>
                        </optgroup>
                        <optgroup label="System Fonts">
                            <option value="Segoe UI">Segoe UI (Default)</option>
                            <option value="Arial">Arial</option>
                            <option value="Helvetica">Helvetica</option>
                            <option value="Georgia">Georgia</option>
                            <option value="Impact">Impact</option>
                        </optgroup>
                    </select>
                    <div class="font-preview" id="font-preview">Sample Text 123</div>
                </div>

                <div class="control-group">
                    <label>Widget Gap</label>
                    <input type="range" id="gap" min="-5" max="30" value="5">
                    <div class="range-value"><span id="gap-display">5</span>px</div>
                </div>

                <div class="section-divider"></div>

                <!-- Widget Sections -->
                <div id="widget-sections">
                    <!-- Followers Widget -->
                    <div class="widget-section" data-widget="followers">
                        <div class="widget-header" onclick="toggleWidgetSection('followers')">
                            <h3><span class="widget-color" style="background: #9146ff;"></span> Followers Widget</h3>
                            <div class="widget-header-controls">
                                <label class="toggle-switch" onclick="event.stopPropagation()">
                                    <input type="checkbox" id="followers-enabled" checked onchange="toggleWidgetVisibility('followers')">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="collapse-icon">â–¼</span>
                            </div>
                        </div>
                        <div class="widget-content">
                            <div class="preset-section">
                                <label>Apply Theme Preset</label>
                                <div class="preset-grid" data-widget="followers"></div>
                            </div>

                            <div class="control-row">
                                <div class="control-group">
                                    <label>Text Color</label>
                                    <div class="color-input-wrapper">
                                        <input type="color" id="followers-text-color-picker" value="#9146ff">
                                        <input type="text" id="followers-text-color" value="#9146ff">
                                    </div>
                                </div>
                                <div class="control-group">
                                    <label>Label Color</label>
                                    <div class="color-input-wrapper">
                                        <input type="color" id="followers-label-color-picker" value="#aaaaaa">
                                        <input type="text" id="followers-label-color" value="#aaaaaa">
                                    </div>
                                </div>
                            </div>

                            <div class="control-row">
                                <div class="control-group">
                                    <label>Border Color</label>
                                    <div class="color-input-wrapper">
                                        <input type="color" id="followers-border-color-picker" value="#9146ff">
                                        <input type="text" id="followers-border-color" value="#9146ff">
                                    </div>
                                </div>
                                <div class="control-group">
                                    <label>Background</label>
                                    <div class="checkbox-wrapper">
                                        <input type="checkbox" id="followers-bg-enabled">
                                        <label for="followers-bg-enabled">Enable BG</label>
                                    </div>
                                </div>
                            </div>

                            <div class="control-group" id="followers-bg-color-group" style="display: none;">
                                <label>Background Color</label>
                                <div class="color-input-wrapper">
                                    <input type="color" id="followers-bg-color-picker" value="#000000">
                                    <input type="text" id="followers-bg-color" value="rgba(0,0,0,0.3)">
                                </div>
                                <div class="control-group" style="margin-top: 10px;">
                                    <label>Background Opacity</label>
                                    <input type="range" id="followers-bg-opacity" min="0" max="100" value="30">
                                    <div class="range-value"><span id="followers-bg-opacity-display">30</span>%</div>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>Text Shadow</label>
                                <div class="text-shadow-options">
                                    <button class="shadow-preset active" data-widget="followers" data-shadow="2px 2px 4px rgba(0,0,0,0.8)">Default</button>
                                    <button class="shadow-preset" data-widget="followers" data-shadow="none">None</button>
                                    <button class="shadow-preset" data-widget="followers" data-shadow="0 0 10px rgba(145,70,255,0.8)">Glow</button>
                                    <button class="shadow-preset" data-widget="followers" data-shadow="3px 3px 0 rgba(0,0,0,0.5)">Hard</button>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>Border Style</label>
                                <div class="border-style-options">
                                    <button class="border-style-btn active" data-widget="followers" data-style="solid">Solid</button>
                                    <button class="border-style-btn" data-widget="followers" data-style="dashed">Dashed</button>
                                    <button class="border-style-btn" data-widget="followers" data-style="dotted">Dotted</button>
                                    <button class="border-style-btn" data-widget="followers" data-style="double">Double</button>
                                    <button class="border-style-btn" data-widget="followers" data-style="none">None</button>
                                </div>
                            </div>

                            <div class="control-row-3">
                                <div class="control-group control-small">
                                    <label>Text Size</label>
                                    <input type="range" id="followers-font-size" min="20" max="150" value="48">
                                    <div class="range-value"><span id="followers-font-size-display">48</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Label Size</label>
                                    <input type="range" id="followers-label-font-size" min="10" max="60" value="14">
                                    <div class="range-value"><span id="followers-label-font-size-display">14</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Label Gap</label>
                                    <input type="range" id="followers-label-gap" min="-20" max="20" value="5">
                                    <div class="range-value"><span id="followers-label-gap-display">5</span>px</div>
                                </div>
                            </div>

                            <div class="control-row-4">
                                <div class="control-group control-small">
                                    <label>Border</label>
                                    <input type="range" id="followers-border-width" min="0" max="10" value="2">
                                    <div class="range-value"><span id="followers-border-width-display">2</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Radius</label>
                                    <input type="range" id="followers-border-radius" min="0" max="30" value="0">
                                    <div class="range-value"><span id="followers-border-radius-display">0</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Pad V</label>
                                    <input type="range" id="followers-padding-v" min="0" max="30" value="8">
                                    <div class="range-value"><span id="followers-padding-v-display">8</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Pad H</label>
                                    <input type="range" id="followers-padding-h" min="0" max="40" value="15">
                                    <div class="range-value"><span id="followers-padding-h-display">15</span>px</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Subscriber Goal Widget -->
                    <div class="widget-section" data-widget="subgoal">
                        <div class="widget-header" onclick="toggleWidgetSection('subgoal')">
                            <h3><span class="widget-color" style="background: #00d2d3;"></span> Subscriber Goal Widget</h3>
                            <div class="widget-header-controls">
                                <label class="toggle-switch" onclick="event.stopPropagation()">
                                    <input type="checkbox" id="subgoal-enabled" checked onchange="toggleWidgetVisibility('subgoal')">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="collapse-icon">â–¼</span>
                            </div>
                        </div>
                        <div class="widget-content">
                            <div class="preset-section">
                                <label>Apply Theme Preset</label>
                                <div class="preset-grid" data-widget="subgoal"></div>
                            </div>

                            <div class="control-row">
                                <div class="control-group">
                                    <label>Text Color</label>
                                    <div class="color-input-wrapper">
                                        <input type="color" id="subgoal-text-color-picker" value="#00d2d3">
                                        <input type="text" id="subgoal-text-color" value="#00d2d3">
                                    </div>
                                </div>
                                <div class="control-group">
                                    <label>Label Color</label>
                                    <div class="color-input-wrapper">
                                        <input type="color" id="subgoal-label-color-picker" value="#aaaaaa">
                                        <input type="text" id="subgoal-label-color" value="#aaaaaa">
                                    </div>
                                </div>
                            </div>

                            <div class="control-row">
                                <div class="control-group">
                                    <label>Border Color</label>
                                    <div class="color-input-wrapper">
                                        <input type="color" id="subgoal-border-color-picker" value="#00d2d3">
                                        <input type="text" id="subgoal-border-color" value="#00d2d3">
                                    </div>
                                </div>
                                <div class="control-group">
                                    <label>Background</label>
                                    <div class="checkbox-wrapper">
                                        <input type="checkbox" id="subgoal-bg-enabled">
                                        <label for="subgoal-bg-enabled">Enable BG</label>
                                    </div>
                                </div>
                            </div>

                            <div class="control-group" id="subgoal-bg-color-group" style="display: none;">
                                <label>Background Color</label>
                                <div class="color-input-wrapper">
                                    <input type="color" id="subgoal-bg-color-picker" value="#000000">
                                    <input type="text" id="subgoal-bg-color" value="rgba(0,0,0,0.3)">
                                </div>
                                <div class="control-group" style="margin-top: 10px;">
                                    <label>Background Opacity</label>
                                    <input type="range" id="subgoal-bg-opacity" min="0" max="100" value="30">
                                    <div class="range-value"><span id="subgoal-bg-opacity-display">30</span>%</div>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>Text Shadow</label>
                                <div class="text-shadow-options">
                                    <button class="shadow-preset active" data-widget="subgoal" data-shadow="2px 2px 4px rgba(0,0,0,0.8)">Default</button>
                                    <button class="shadow-preset" data-widget="subgoal" data-shadow="none">None</button>
                                    <button class="shadow-preset" data-widget="subgoal" data-shadow="0 0 10px rgba(0,210,211,0.8)">Glow</button>
                                    <button class="shadow-preset" data-widget="subgoal" data-shadow="3px 3px 0 rgba(0,0,0,0.5)">Hard</button>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>Border Style</label>
                                <div class="border-style-options">
                                    <button class="border-style-btn active" data-widget="subgoal" data-style="solid">Solid</button>
                                    <button class="border-style-btn" data-widget="subgoal" data-style="dashed">Dashed</button>
                                    <button class="border-style-btn" data-widget="subgoal" data-style="dotted">Dotted</button>
                                    <button class="border-style-btn" data-widget="subgoal" data-style="double">Double</button>
                                    <button class="border-style-btn" data-widget="subgoal" data-style="none">None</button>
                                </div>
                            </div>

                            <div class="control-row-3">
                                <div class="control-group control-small">
                                    <label>Text Size</label>
                                    <input type="range" id="subgoal-font-size" min="20" max="150" value="42">
                                    <div class="range-value"><span id="subgoal-font-size-display">42</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Label Size</label>
                                    <input type="range" id="subgoal-label-font-size" min="10" max="60" value="14">
                                    <div class="range-value"><span id="subgoal-label-font-size-display">14</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Label Gap</label>
                                    <input type="range" id="subgoal-label-gap" min="-20" max="20" value="5">
                                    <div class="range-value"><span id="subgoal-label-gap-display">5</span>px</div>
                                </div>
                            </div>

                            <div class="control-row-4">
                                <div class="control-group control-small">
                                    <label>Border</label>
                                    <input type="range" id="subgoal-border-width" min="0" max="10" value="2">
                                    <div class="range-value"><span id="subgoal-border-width-display">2</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Radius</label>
                                    <input type="range" id="subgoal-border-radius" min="0" max="30" value="0">
                                    <div class="range-value"><span id="subgoal-border-radius-display">0</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Pad V</label>
                                    <input type="range" id="subgoal-padding-v" min="0" max="30" value="8">
                                    <div class="range-value"><span id="subgoal-padding-v-display">8</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Pad H</label>
                                    <input type="range" id="subgoal-padding-h" min="0" max="40" value="15">
                                    <div class="range-value"><span id="subgoal-padding-h-display">15</span>px</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bits Today Widget -->
                    <div class="widget-section" data-widget="bits">
                        <div class="widget-header" onclick="toggleWidgetSection('bits')">
                            <h3><span class="widget-color" style="background: #2ed573;"></span> Bits Today Widget</h3>
                            <div class="widget-header-controls">
                                <label class="toggle-switch" onclick="event.stopPropagation()">
                                    <input type="checkbox" id="bits-enabled" checked onchange="toggleWidgetVisibility('bits')">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="collapse-icon">â–¼</span>
                            </div>
                        </div>
                        <div class="widget-content">
                            <div class="preset-section">
                                <label>Apply Theme Preset</label>
                                <div class="preset-grid" data-widget="bits"></div>
                            </div>

                            <div class="control-row">
                                <div class="control-group">
                                    <label>Text Color</label>
                                    <div class="color-input-wrapper">
                                        <input type="color" id="bits-text-color-picker" value="#2ed573">
                                        <input type="text" id="bits-text-color" value="#2ed573">
                                    </div>
                                </div>
                                <div class="control-group">
                                    <label>Label Color</label>
                                    <div class="color-input-wrapper">
                                        <input type="color" id="bits-label-color-picker" value="#aaaaaa">
                                        <input type="text" id="bits-label-color" value="#aaaaaa">
                                    </div>
                                </div>
                            </div>

                            <div class="control-row">
                                <div class="control-group">
                                    <label>Border Color</label>
                                    <div class="color-input-wrapper">
                                        <input type="color" id="bits-border-color-picker" value="#2ed573">
                                        <input type="text" id="bits-border-color" value="#2ed573">
                                    </div>
                                </div>
                                <div class="control-group">
                                    <label>Background</label>
                                    <div class="checkbox-wrapper">
                                        <input type="checkbox" id="bits-bg-enabled">
                                        <label for="bits-bg-enabled">Enable BG</label>
                                    </div>
                                </div>
                            </div>

                            <div class="control-group" id="bits-bg-color-group" style="display: none;">
                                <label>Background Color</label>
                                <div class="color-input-wrapper">
                                    <input type="color" id="bits-bg-color-picker" value="#000000">
                                    <input type="text" id="bits-bg-color" value="rgba(0,0,0,0.3)">
                                </div>
                                <div class="control-group" style="margin-top: 10px;">
                                    <label>Background Opacity</label>
                                    <input type="range" id="bits-bg-opacity" min="0" max="100" value="30">
                                    <div class="range-value"><span id="bits-bg-opacity-display">30</span>%</div>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>Text Shadow</label>
                                <div class="text-shadow-options">
                                    <button class="shadow-preset active" data-widget="bits" data-shadow="2px 2px 4px rgba(0,0,0,0.8)">Default</button>
                                    <button class="shadow-preset" data-widget="bits" data-shadow="none">None</button>
                                    <button class="shadow-preset" data-widget="bits" data-shadow="0 0 10px rgba(46,213,115,0.8)">Glow</button>
                                    <button class="shadow-preset" data-widget="bits" data-shadow="3px 3px 0 rgba(0,0,0,0.5)">Hard</button>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>Border Style</label>
                                <div class="border-style-options">
                                    <button class="border-style-btn active" data-widget="bits" data-style="solid">Solid</button>
                                    <button class="border-style-btn" data-widget="bits" data-style="dashed">Dashed</button>
                                    <button class="border-style-btn" data-widget="bits" data-style="dotted">Dotted</button>
                                    <button class="border-style-btn" data-widget="bits" data-style="double">Double</button>
                                    <button class="border-style-btn" data-widget="bits" data-style="none">None</button>
                                </div>
                            </div>

                            <div class="control-row-3">
                                <div class="control-group control-small">
                                    <label>Text Size</label>
                                    <input type="range" id="bits-font-size" min="20" max="150" value="42">
                                    <div class="range-value"><span id="bits-font-size-display">42</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Label Size</label>
                                    <input type="range" id="bits-label-font-size" min="10" max="60" value="14">
                                    <div class="range-value"><span id="bits-label-font-size-display">14</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Label Gap</label>
                                    <input type="range" id="bits-label-gap" min="-20" max="20" value="5">
                                    <div class="range-value"><span id="bits-label-gap-display">5</span>px</div>
                                </div>
                            </div>

                            <div class="control-row-4">
                                <div class="control-group control-small">
                                    <label>Border</label>
                                    <input type="range" id="bits-border-width" min="0" max="10" value="2">
                                    <div class="range-value"><span id="bits-border-width-display">2</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Radius</label>
                                    <input type="range" id="bits-border-radius" min="0" max="30" value="0">
                                    <div class="range-value"><span id="bits-border-radius-display">0</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Pad V</label>
                                    <input type="range" id="bits-padding-v" min="0" max="30" value="8">
                                    <div class="range-value"><span id="bits-padding-v-display">8</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Pad H</label>
                                    <input type="range" id="bits-padding-h" min="0" max="40" value="15">
                                    <div class="range-value"><span id="bits-padding-h-display">15</span>px</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hours Streamed Widget (NEW) -->
                    <div class="widget-section" data-widget="hours">
                        <div class="widget-header" onclick="toggleWidgetSection('hours')">
                            <h3><span class="widget-color" style="background: #00bcd4;"></span> Hours Streamed Widget</h3>
                            <div class="widget-header-controls">
                                <label class="toggle-switch" onclick="event.stopPropagation()">
                                    <input type="checkbox" id="hours-enabled" checked onchange="toggleWidgetVisibility('hours')">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="collapse-icon">â–¼</span>
                            </div>
                        </div>
                        <div class="widget-content">
                            <div class="preset-section">
                                <label>Apply Theme Preset</label>
                                <div class="preset-grid" data-widget="hours"></div>
                            </div>

                            <div class="control-row">
                                <div class="control-group">
                                    <label>Text Color</label>
                                    <div class="color-input-wrapper">
                                        <input type="color" id="hours-text-color-picker" value="#00bcd4">
                                        <input type="text" id="hours-text-color" value="#00bcd4">
                                    </div>
                                </div>
                                <div class="control-group">
                                    <label>Label Color</label>
                                    <div class="color-input-wrapper">
                                        <input type="color" id="hours-label-color-picker" value="#aaaaaa">
                                        <input type="text" id="hours-label-color" value="#aaaaaa">
                                    </div>
                                </div>
                            </div>

                            <div class="control-row">
                                <div class="control-group">
                                    <label>Border Color</label>
                                    <div class="color-input-wrapper">
                                        <input type="color" id="hours-border-color-picker" value="#00bcd4">
                                        <input type="text" id="hours-border-color" value="#00bcd4">
                                    </div>
                                </div>
                                <div class="control-group">
                                    <label>Background</label>
                                    <div class="checkbox-wrapper">
                                        <input type="checkbox" id="hours-bg-enabled">
                                        <label for="hours-bg-enabled">Enable BG</label>
                                    </div>
                                </div>
                            </div>

                            <div class="control-group" id="hours-bg-color-group" style="display: none;">
                                <label>Background Color</label>
                                <div class="color-input-wrapper">
                                    <input type="color" id="hours-bg-color-picker" value="#000000">
                                    <input type="text" id="hours-bg-color" value="rgba(0,0,0,0.3)">
                                </div>
                                <div class="control-group" style="margin-top: 10px;">
                                    <label>Background Opacity</label>
                                    <input type="range" id="hours-bg-opacity" min="0" max="100" value="30">
                                    <div class="range-value"><span id="hours-bg-opacity-display">30</span>%</div>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>Text Shadow</label>
                                <div class="text-shadow-options">
                                    <button class="shadow-preset active" data-widget="hours" data-shadow="2px 2px 4px rgba(0,0,0,0.8)">Default</button>
                                    <button class="shadow-preset" data-widget="hours" data-shadow="none">None</button>
                                    <button class="shadow-preset" data-widget="hours" data-shadow="0 0 10px rgba(0,188,212,0.8)">Glow</button>
                                    <button class="shadow-preset" data-widget="hours" data-shadow="3px 3px 0 rgba(0,0,0,0.5)">Hard</button>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>Border Style</label>
                                <div class="border-style-options">
                                    <button class="border-style-btn active" data-widget="hours" data-style="solid">Solid</button>
                                    <button class="border-style-btn" data-widget="hours" data-style="dashed">Dashed</button>
                                    <button class="border-style-btn" data-widget="hours" data-style="dotted">Dotted</button>
                                    <button class="border-style-btn" data-widget="hours" data-style="double">Double</button>
                                    <button class="border-style-btn" data-widget="hours" data-style="none">None</button>
                                </div>
                            </div>

                            <div class="control-row-3">
                                <div class="control-group control-small">
                                    <label>Text Size</label>
                                    <input type="range" id="hours-font-size" min="20" max="150" value="42">
                                    <div class="range-value"><span id="hours-font-size-display">42</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Label Size</label>
                                    <input type="range" id="hours-label-font-size" min="10" max="60" value="14">
                                    <div class="range-value"><span id="hours-label-font-size-display">14</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Label Gap</label>
                                    <input type="range" id="hours-label-gap" min="-20" max="20" value="5">
                                    <div class="range-value"><span id="hours-label-gap-display">5</span>px</div>
                                </div>
                            </div>

                            <div class="control-row-4">
                                <div class="control-group control-small">
                                    <label>Border</label>
                                    <input type="range" id="hours-border-width" min="0" max="10" value="2">
                                    <div class="range-value"><span id="hours-border-width-display">2</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Radius</label>
                                    <input type="range" id="hours-border-radius" min="0" max="30" value="0">
                                    <div class="range-value"><span id="hours-border-radius-display">0</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Pad V</label>
                                    <input type="range" id="hours-padding-v" min="0" max="30" value="8">
                                    <div class="range-value"><span id="hours-padding-v-display">8</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Pad H</label>
                                    <input type="range" id="hours-padding-h" min="0" max="40" value="15">
                                    <div class="range-value"><span id="hours-padding-h-display">15</span>px</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Monthly Widget -->
                    <div class="widget-section" data-widget="monthly">
                        <div class="widget-header" onclick="toggleWidgetSection('monthly')">
                            <h3><span class="widget-color" style="background: #ff6b6b;"></span> Monthly Artists Widget</h3>
                            <div class="widget-header-controls">
                                <label class="toggle-switch" onclick="event.stopPropagation()">
                                    <input type="checkbox" id="monthly-enabled" checked onchange="toggleWidgetVisibility('monthly')">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="collapse-icon">â–¼</span>
                            </div>
                        </div>
                        <div class="widget-content">
                            <div class="preset-section">
                                <label>Apply Theme Preset</label>
                                <div class="preset-grid" data-widget="monthly"></div>
                            </div>

                            <div class="control-row">
                                <div class="control-group">
                                    <label>Text Color</label>
                                    <div class="color-input-wrapper">
                                        <input type="color" id="monthly-text-color-picker" value="#ff6b6b">
                                        <input type="text" id="monthly-text-color" value="#ff6b6b">
                                    </div>
                                </div>
                                <div class="control-group">
                                    <label>Label Color</label>
                                    <div class="color-input-wrapper">
                                        <input type="color" id="monthly-label-color-picker" value="#aaaaaa">
                                        <input type="text" id="monthly-label-color" value="#aaaaaa">
                                    </div>
                                </div>
                            </div>

                            <div class="control-row">
                                <div class="control-group">
                                    <label>Border Color</label>
                                    <div class="color-input-wrapper">
                                        <input type="color" id="monthly-border-color-picker" value="#ff6b6b">
                                        <input type="text" id="monthly-border-color" value="#ff6b6b">
                                    </div>
                                </div>
                                <div class="control-group">
                                    <label>Background</label>
                                    <div class="checkbox-wrapper">
                                        <input type="checkbox" id="monthly-bg-enabled">
                                        <label for="monthly-bg-enabled">Enable BG</label>
                                    </div>
                                </div>
                            </div>

                            <div class="control-group" id="monthly-bg-color-group" style="display: none;">
                                <label>Background Color</label>
                                <div class="color-input-wrapper">
                                    <input type="color" id="monthly-bg-color-picker" value="#000000">
                                    <input type="text" id="monthly-bg-color" value="rgba(0,0,0,0.3)">
                                </div>
                                <div class="control-group" style="margin-top: 10px;">
                                    <label>Background Opacity</label>
                                    <input type="range" id="monthly-bg-opacity" min="0" max="100" value="30">
                                    <div class="range-value"><span id="monthly-bg-opacity-display">30</span>%</div>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>Text Shadow</label>
                                <div class="text-shadow-options">
                                    <button class="shadow-preset active" data-widget="monthly" data-shadow="2px 2px 4px rgba(0,0,0,0.8)">Default</button>
                                    <button class="shadow-preset" data-widget="monthly" data-shadow="none">None</button>
                                    <button class="shadow-preset" data-widget="monthly" data-shadow="0 0 10px rgba(255,107,107,0.8)">Glow</button>
                                    <button class="shadow-preset" data-widget="monthly" data-shadow="3px 3px 0 rgba(0,0,0,0.5)">Hard</button>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>Border Style</label>
                                <div class="border-style-options">
                                    <button class="border-style-btn active" data-widget="monthly" data-style="solid">Solid</button>
                                    <button class="border-style-btn" data-widget="monthly" data-style="dashed">Dashed</button>
                                    <button class="border-style-btn" data-widget="monthly" data-style="dotted">Dotted</button>
                                    <button class="border-style-btn" data-widget="monthly" data-style="double">Double</button>
                                    <button class="border-style-btn" data-widget="monthly" data-style="none">None</button>
                                </div>
                            </div>

                            <div class="control-row-3">
                                <div class="control-group control-small">
                                    <label>Text Size</label>
                                    <input type="range" id="monthly-font-size" min="20" max="150" value="42">
                                    <div class="range-value"><span id="monthly-font-size-display">42</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Label Size</label>
                                    <input type="range" id="monthly-label-font-size" min="10" max="60" value="14">
                                    <div class="range-value"><span id="monthly-label-font-size-display">14</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Label Gap</label>
                                    <input type="range" id="monthly-label-gap" min="-20" max="20" value="5">
                                    <div class="range-value"><span id="monthly-label-gap-display">5</span>px</div>
                                </div>
                            </div>

                            <div class="control-row-4">
                                <div class="control-group control-small">
                                    <label>Border</label>
                                    <input type="range" id="monthly-border-width" min="0" max="10" value="2">
                                    <div class="range-value"><span id="monthly-border-width-display">2</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Radius</label>
                                    <input type="range" id="monthly-border-radius" min="0" max="30" value="0">
                                    <div class="range-value"><span id="monthly-border-radius-display">0</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Pad V</label>
                                    <input type="range" id="monthly-padding-v" min="0" max="30" value="8">
                                    <div class="range-value"><span id="monthly-padding-v-display">8</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Pad H</label>
                                    <input type="range" id="monthly-padding-h" min="0" max="40" value="15">
                                    <div class="range-value"><span id="monthly-padding-h-display">15</span>px</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lifetime Widget -->
                    <div class="widget-section" data-widget="lifetime">
                        <div class="widget-header" onclick="toggleWidgetSection('lifetime')">
                            <h3><span class="widget-color" style="background: #ffd700;"></span> Lifetime Artists Widget</h3>
                            <div class="widget-header-controls">
                                <label class="toggle-switch" onclick="event.stopPropagation()">
                                    <input type="checkbox" id="lifetime-enabled" checked onchange="toggleWidgetVisibility('lifetime')">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="collapse-icon">â–¼</span>
                            </div>
                        </div>
                        <div class="widget-content">
                            <div class="preset-section">
                                <label>Apply Theme Preset</label>
                                <div class="preset-grid" data-widget="lifetime"></div>
                            </div>

                            <div class="control-row">
                                <div class="control-group">
                                    <label>Text Color</label>
                                    <div class="color-input-wrapper">
                                        <input type="color" id="lifetime-text-color-picker" value="#ffd700">
                                        <input type="text" id="lifetime-text-color" value="#ffd700">
                                    </div>
                                </div>
                                <div class="control-group">
                                    <label>Label Color</label>
                                    <div class="color-input-wrapper">
                                        <input type="color" id="lifetime-label-color-picker" value="#aaaaaa">
                                        <input type="text" id="lifetime-label-color" value="#aaaaaa">
                                    </div>
                                </div>
                            </div>

                            <div class="control-row">
                                <div class="control-group">
                                    <label>Border Color</label>
                                    <div class="color-input-wrapper">
                                        <input type="color" id="lifetime-border-color-picker" value="#ffd700">
                                        <input type="text" id="lifetime-border-color" value="#ffd700">
                                    </div>
                                </div>
                                <div class="control-group">
                                    <label>Background</label>
                                    <div class="checkbox-wrapper">
                                        <input type="checkbox" id="lifetime-bg-enabled">
                                        <label for="lifetime-bg-enabled">Enable BG</label>
                                    </div>
                                </div>
                            </div>

                            <div class="control-group" id="lifetime-bg-color-group" style="display: none;">
                                <label>Background Color</label>
                                <div class="color-input-wrapper">
                                    <input type="color" id="lifetime-bg-color-picker" value="#000000">
                                    <input type="text" id="lifetime-bg-color" value="rgba(0,0,0,0.3)">
                                </div>
                                <div class="control-group" style="margin-top: 10px;">
                                    <label>Background Opacity</label>
                                    <input type="range" id="lifetime-bg-opacity" min="0" max="100" value="30">
                                    <div class="range-value"><span id="lifetime-bg-opacity-display">30</span>%</div>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>Text Shadow</label>
                                <div class="text-shadow-options">
                                    <button class="shadow-preset active" data-widget="lifetime" data-shadow="2px 2px 4px rgba(0,0,0,0.8)">Default</button>
                                    <button class="shadow-preset" data-widget="lifetime" data-shadow="none">None</button>
                                    <button class="shadow-preset" data-widget="lifetime" data-shadow="0 0 10px rgba(255,215,0,0.8)">Glow</button>
                                    <button class="shadow-preset" data-widget="lifetime" data-shadow="3px 3px 0 rgba(0,0,0,0.5)">Hard</button>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>Border Style</label>
                                <div class="border-style-options">
                                    <button class="border-style-btn active" data-widget="lifetime" data-style="solid">Solid</button>
                                    <button class="border-style-btn" data-widget="lifetime" data-style="dashed">Dashed</button>
                                    <button class="border-style-btn" data-widget="lifetime" data-style="dotted">Dotted</button>
                                    <button class="border-style-btn" data-widget="lifetime" data-style="double">Double</button>
                                    <button class="border-style-btn" data-widget="lifetime" data-style="none">None</button>
                                </div>
                            </div>

                            <div class="control-row-3">
                                <div class="control-group control-small">
                                    <label>Text Size</label>
                                    <input type="range" id="lifetime-font-size" min="20" max="150" value="36">
                                    <div class="range-value"><span id="lifetime-font-size-display">36</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Label Size</label>
                                    <input type="range" id="lifetime-label-font-size" min="10" max="60" value="14">
                                    <div class="range-value"><span id="lifetime-label-font-size-display">14</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Label Gap</label>
                                    <input type="range" id="lifetime-label-gap" min="-20" max="20" value="5">
                                    <div class="range-value"><span id="lifetime-label-gap-display">5</span>px</div>
                                </div>
                            </div>

                            <div class="control-row-4">
                                <div class="control-group control-small">
                                    <label>Border</label>
                                    <input type="range" id="lifetime-border-width" min="0" max="10" value="2">
                                    <div class="range-value"><span id="lifetime-border-width-display">2</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Radius</label>
                                    <input type="range" id="lifetime-border-radius" min="0" max="30" value="0">
                                    <div class="range-value"><span id="lifetime-border-radius-display">0</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Pad V</label>
                                    <input type="range" id="lifetime-padding-v" min="0" max="30" value="8">
                                    <div class="range-value"><span id="lifetime-padding-v-display">8</span>px</div>
                                </div>
                                <div class="control-group control-small">
                                    <label>Pad H</label>
                                    <input type="range" id="lifetime-padding-h" min="0" max="40" value="15">
                                    <div class="range-value"><span id="lifetime-padding-h-display">15</span>px</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Saved Custom Presets Section -->
                <div class="saved-presets-section">
                    <h3>Custom Presets</h3>
                    <p style="font-size: 11px; color: #666; margin-bottom: 12px;">Create and save your own theme presets. Click Edit to rename or change colors.</p>
                    <div class="save-preset-row">
                        <button class="btn btn-primary" onclick="openNewPresetModal()" style="flex: 1;">+ Create New Preset</button>
                        <button class="btn btn-secondary" onclick="saveCurrentAsPreset()" title="Quick save current followers widget style">Quick Save</button>
                    </div>
                    <div class="saved-preset-list" id="saved-preset-list">
                        <!-- Saved presets will be rendered here -->
                    </div>
                </div>

                <!-- Widget Groups Section -->
                <div class="widget-groups-section">
                    <h3>Widget Groups (Rotation)</h3>
                    <p>Combine widgets to rotate in one spot. Saves screen space in OBS.</p>
                    <div class="group-list" id="group-list">
                        <!-- Groups will be rendered here -->
                    </div>
                    <button class="btn btn-primary" onclick="openNewGroupModal()" style="width: 100%;">+ Create Widget Group</button>
                </div>

                <div class="sticky-buttons">
                    <div class="button-row">
                        <button class="btn btn-primary" onclick="saveBranding()">ðŸ’¾ Save Branding</button>
                        <button class="btn btn-secondary" onclick="resetBranding()">Reset to Default</button>
                    </div>
                    <div id="status-message" class="status-message"></div>
                </div>
            </div>
        </div>

        <div class="preview-section">
            <div class="panel">
                <h2>Live Preview</h2>
                <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Drag widgets to reorder them</p>

                <div class="preview-box">
                    <div class="sidebar2-preview" id="preview-container">
                        <!-- Widgets will be rendered here by JS in order -->
                    </div>
                </div>
                <div class="drag-hint">Drag and drop widgets above to change their order</div>
            </div>

            <div class="panel" style="margin-top: 20px;">
                <h2>Export Configuration</h2>
                <p style="font-size: 13px; color: #a0aec0; margin-bottom: 15px;">This code will be saved to branding-setup.js:</p>
                <textarea id="export-code" style="width: 100%; height: 300px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 15px; color: #a0aec0; font-family: monospace; font-size: 10px; resize: none;" readonly></textarea>
                <button class="btn btn-primary" style="margin-top: 15px;" onclick="copyExportCode()">Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <script>
        // Widget definitions with labels and sample values
        const widgetDefs = {
            followers: { label: 'Followers', sampleValue: '1,234' },
            subgoal: { label: 'Subs Goal', sampleValue: '23 / 150' },
            bits: { label: 'Bits Today', sampleValue: '$12.34' },
            hours: { label: 'Hours Streamed', sampleValue: '127.5' },
            monthly: { label: 'Artists (Monthly)', sampleValue: '$45' },
            lifetime: { label: 'Artists (Lifetime)', sampleValue: '$1,250' }
        };

        // Built-in theme presets
        const themePresets = {
            'twitch': {
                name: 'Twitch',
                colors: { text: '#9146ff', label: '#aaaaaa', border: '#9146ff' },
                textShadow: '2px 2px 4px rgba(0,0,0,0.8)',
                border: { width: 2, style: 'solid', radius: 0 }
            },
            'neon-green': {
                name: 'Neon',
                colors: { text: '#00ff00', label: '#88ff88', border: '#00ff00' },
                textShadow: '0 0 10px rgba(0,255,0,0.8)',
                border: { width: 2, style: 'solid', radius: 8 }
            },
            'fire': {
                name: 'Fire',
                colors: { text: '#ff6b35', label: '#ffaa00', border: '#ff4500' },
                textShadow: '0 0 10px rgba(255,69,0,0.8)',
                border: { width: 2, style: 'solid', radius: 4 }
            },
            'ice': {
                name: 'Ice',
                colors: { text: '#00d4ff', label: '#88e4ff', border: '#00aaff' },
                textShadow: '0 0 10px rgba(0,170,255,0.6)',
                border: { width: 2, style: 'solid', radius: 12 }
            },
            'gold': {
                name: 'Gold',
                colors: { text: '#ffd700', label: '#ffec8b', border: '#daa520' },
                textShadow: '2px 2px 4px rgba(0,0,0,0.8)',
                border: { width: 3, style: 'double', radius: 0 }
            },
            'cyber': {
                name: 'Cyber',
                colors: { text: '#ff00ff', label: '#ff88ff', border: '#cc00cc' },
                textShadow: '0 0 15px rgba(255,0,255,0.8)',
                border: { width: 2, style: 'dashed', radius: 0 }
            },
            'ocean': {
                name: 'Ocean',
                colors: { text: '#00bcd4', label: '#80deea', border: '#0097a7' },
                textShadow: '2px 2px 4px rgba(0,0,0,0.8)',
                border: { width: 2, style: 'solid', radius: 10 }
            },
            'minimal': {
                name: 'Minimal',
                colors: { text: '#ffffff', label: '#888888', border: '#444444' },
                textShadow: 'none',
                border: { width: 1, style: 'solid', radius: 4 }
            }
        };

        // Custom saved presets (loaded from localStorage)
        let customPresets = {};

        // Default modular configuration
        const defaultConfig = {
            fontFamily: "Bebas Neue",
            googleFont: true,
            fontWeight: "bold",
            textShadow: "2px 2px 4px rgba(0,0,0,0.8)",
            layout: {
                gap: 5
            },
            widgetOrder: ['followers', 'subgoal', 'bits', 'hours', 'monthly', 'lifetime'],
            widgetGroups: [],  // Array of {id, name, widgets: [], interval: 10, animation: 'fade'}
            widgets: {
                followers: {
                    enabled: true,
                    fontSize: 48,
                    labelFontSize: 14,
                    labelGap: 5,
                    colors: {
                        text: "#9146ff",
                        label: "#aaaaaa",
                        border: "#9146ff",
                        background: "rgba(0,0,0,0.3)"
                    },
                    border: {
                        width: 2,
                        style: "solid",
                        radius: 0
                    },
                    background: {
                        enabled: false,
                        color: "rgba(0,0,0,0.3)",
                        opacity: 30
                    },
                    padding: {
                        vertical: 8,
                        horizontal: 15
                    },
                    textShadow: "2px 2px 4px rgba(0,0,0,0.8)"
                },
                subgoal: {
                    enabled: true,
                    fontSize: 42,
                    labelFontSize: 14,
                    labelGap: 5,
                    colors: {
                        text: "#00d2d3",
                        label: "#aaaaaa",
                        border: "#00d2d3",
                        background: "rgba(0,0,0,0.3)"
                    },
                    border: {
                        width: 2,
                        style: "solid",
                        radius: 0
                    },
                    background: {
                        enabled: false,
                        color: "rgba(0,0,0,0.3)",
                        opacity: 30
                    },
                    padding: {
                        vertical: 8,
                        horizontal: 15
                    },
                    textShadow: "2px 2px 4px rgba(0,0,0,0.8)"
                },
                bits: {
                    enabled: true,
                    fontSize: 42,
                    labelFontSize: 14,
                    labelGap: 5,
                    colors: {
                        text: "#2ed573",
                        label: "#aaaaaa",
                        border: "#2ed573",
                        background: "rgba(0,0,0,0.3)"
                    },
                    border: {
                        width: 2,
                        style: "solid",
                        radius: 0
                    },
                    background: {
                        enabled: false,
                        color: "rgba(0,0,0,0.3)",
                        opacity: 30
                    },
                    padding: {
                        vertical: 8,
                        horizontal: 15
                    },
                    textShadow: "2px 2px 4px rgba(0,0,0,0.8)"
                },
                hours: {
                    enabled: true,
                    fontSize: 42,
                    labelFontSize: 14,
                    labelGap: 5,
                    colors: {
                        text: "#00bcd4",
                        label: "#aaaaaa",
                        border: "#00bcd4",
                        background: "rgba(0,0,0,0.3)"
                    },
                    border: {
                        width: 2,
                        style: "solid",
                        radius: 0
                    },
                    background: {
                        enabled: false,
                        color: "rgba(0,0,0,0.3)",
                        opacity: 30
                    },
                    padding: {
                        vertical: 8,
                        horizontal: 15
                    },
                    textShadow: "2px 2px 4px rgba(0,0,0,0.8)"
                },
                monthly: {
                    enabled: true,
                    fontSize: 42,
                    labelFontSize: 14,
                    labelGap: 5,
                    colors: {
                        text: "#ff6b6b",
                        label: "#aaaaaa",
                        border: "#ff6b6b",
                        background: "rgba(0,0,0,0.3)"
                    },
                    border: {
                        width: 2,
                        style: "solid",
                        radius: 0
                    },
                    background: {
                        enabled: false,
                        color: "rgba(0,0,0,0.3)",
                        opacity: 30
                    },
                    padding: {
                        vertical: 8,
                        horizontal: 15
                    },
                    textShadow: "2px 2px 4px rgba(0,0,0,0.8)"
                },
                lifetime: {
                    enabled: true,
                    fontSize: 36,
                    labelFontSize: 14,
                    labelGap: 5,
                    colors: {
                        text: "#ffd700",
                        label: "#aaaaaa",
                        border: "#ffd700",
                        background: "rgba(0,0,0,0.3)"
                    },
                    border: {
                        width: 2,
                        style: "solid",
                        radius: 0
                    },
                    background: {
                        enabled: false,
                        color: "rgba(0,0,0,0.3)",
                        opacity: 30
                    },
                    padding: {
                        vertical: 8,
                        horizontal: 15
                    },
                    textShadow: "2px 2px 4px rgba(0,0,0,0.8)"
                }
            }
        };

        let currentConfig = JSON.parse(JSON.stringify(defaultConfig));

        const googleFonts = [
            "Bebas Neue", "Oswald", "Montserrat", "Poppins", "Roboto", "Open Sans",
            "Orbitron", "Russo One", "Black Ops One", "Press Start 2P", "Bungee",
            "Playfair Display", "Lato", "Raleway", "Nunito", "Work Sans",
            "Lobster", "Pacifico", "Permanent Marker", "Righteous", "Fredoka One"
        ];

        const widgets = ['followers', 'subgoal', 'bits', 'hours', 'monthly', 'lifetime'];

        // Drag and drop state
        let draggedWidget = null;

        function init() {
            loadConfig();
            loadCustomPresets();
            setupEventListeners();
            setupModalListeners();
            setupGroupModalListeners();
            setupDragAndDrop();
            loadGoogleFont(currentConfig.fontFamily);
            renderPreviewWidgets();
            renderPresetButtons();
            renderSavedPresetsList();
            renderGroupList();
            updatePreview();
            updateExportCode();
            startGroupRotations();
        }

        // Preset functions
        function loadCustomPresets() {
            try {
                const stored = localStorage.getItem('customBrandingPresets');
                if (stored) {
                    customPresets = JSON.parse(stored);
                }
            } catch (e) {
                customPresets = {};
            }
        }

        function saveCustomPresetsToStorage() {
            localStorage.setItem('customBrandingPresets', JSON.stringify(customPresets));
        }

        function renderPresetButtons() {
            document.querySelectorAll('.preset-grid').forEach(grid => {
                const widget = grid.dataset.widget;
                grid.innerHTML = '';

                // Built-in presets
                Object.entries(themePresets).forEach(([key, preset]) => {
                    const btn = document.createElement('button');
                    btn.className = 'preset-btn';
                    btn.dataset.preset = key;
                    btn.dataset.widget = widget;
                    btn.title = `Click to apply. Right-click to copy as custom preset.`;
                    btn.innerHTML = `
                        <div class="preset-preview" style="background: ${preset.colors.border}; color: ${preset.colors.text}; border: 2px ${preset.border.style} ${preset.colors.border}; text-shadow: ${preset.textShadow};">
                            Aa
                        </div>
                        ${preset.name}
                    `;
                    btn.onclick = () => applyPresetToWidget(widget, preset);
                    btn.oncontextmenu = (e) => {
                        e.preventDefault();
                        copyBuiltinToCustom(key, preset);
                    };
                    grid.appendChild(btn);
                });

                // Custom presets (show first 4)
                Object.entries(customPresets).slice(0, 4).forEach(([name, preset]) => {
                    const btn = document.createElement('button');
                    btn.className = 'preset-btn';
                    btn.dataset.preset = 'custom-' + name;
                    btn.dataset.widget = widget;
                    btn.title = `Click to apply "${name}"`;
                    btn.innerHTML = `
                        <div class="preset-preview" style="background: ${preset.colors.border}; color: ${preset.colors.text}; border: 2px ${preset.border.style} ${preset.colors.border};">
                            Aa
                        </div>
                        ${name.substring(0, 8)}
                    `;
                    btn.onclick = () => applyPresetToWidget(widget, preset);
                    grid.appendChild(btn);
                });
            });
        }

        function copyBuiltinToCustom(key, preset) {
            // Generate a unique name based on the built-in preset
            let baseName = preset.name + ' Custom';
            let name = baseName;
            let counter = 1;
            while (customPresets[name]) {
                counter++;
                name = `${baseName} ${counter}`;
            }

            // Copy to custom presets
            customPresets[name] = {
                name: name,
                colors: { ...preset.colors },
                textShadow: preset.textShadow,
                border: { ...preset.border }
            };

            saveCustomPresetsToStorage();
            renderPresetButtons();
            renderSavedPresetsList();

            // Open the editor for the new preset
            openEditPresetModal(name);
            showStatus(`Copied "${preset.name}" - now customize it!`, true);
        }

        function applyPresetToWidget(widget, preset) {
            const w = currentConfig.widgets[widget];
            if (!w) return;

            // Apply colors
            if (preset.colors) {
                w.colors.text = preset.colors.text;
                w.colors.label = preset.colors.label;
                w.colors.border = preset.colors.border;
            }

            // Apply border settings
            if (preset.border) {
                w.border.width = preset.border.width;
                w.border.style = preset.border.style;
                w.border.radius = preset.border.radius;
            }

            // Apply text shadow
            if (preset.textShadow) {
                w.textShadow = preset.textShadow;
            }

            // Update controls
            applyToControls();
            updatePreview();
            updateExportCode();
            showStatus(`Applied "${preset.name || 'preset'}" to ${widget}`, true);
        }

        function saveCurrentAsPreset() {
            // Generate a unique default name
            let baseName = 'My Preset';
            let name = baseName;
            let counter = 1;
            while (customPresets[name]) {
                counter++;
                name = `${baseName} ${counter}`;
            }

            // Get current widget settings (use followers as the base)
            const widget = currentConfig.widgets.followers;

            customPresets[name] = {
                name: name,
                colors: { ...widget.colors },
                textShadow: widget.textShadow,
                border: { ...widget.border }
            };

            saveCustomPresetsToStorage();
            renderPresetButtons();
            renderSavedPresetsList();
            showStatus(`Quick saved as "${name}" - click Edit to rename`, true);
        }

        function renderSavedPresetsList() {
            const list = document.getElementById('saved-preset-list');
            list.innerHTML = '';

            if (Object.keys(customPresets).length === 0) {
                list.innerHTML = '<div style="color: #666; font-size: 12px; text-align: center; padding: 10px;">No saved presets yet. Save your current widget style as a preset above.</div>';
                return;
            }

            Object.entries(customPresets).forEach(([name, preset]) => {
                const item = document.createElement('div');
                item.className = 'saved-preset-item';
                const escapedName = name.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                item.innerHTML = `
                    <span class="saved-preset-name" style="display: flex; align-items: center; gap: 8px;">
                        <span style="width: 16px; height: 16px; border-radius: 50%; background: ${preset.colors.text}; border: 2px solid ${preset.colors.border};"></span>
                        ${name}
                    </span>
                    <div class="saved-preset-actions">
                        <button onclick="applyPresetToAllWidgets('${escapedName}')">Apply</button>
                        <button onclick="openEditPresetModal('${escapedName}')">Edit</button>
                        <button class="delete" onclick="deleteCustomPreset('${escapedName}')">Delete</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        // Modal state
        let editingPresetName = null;

        function openEditPresetModal(presetName) {
            const preset = customPresets[presetName];
            if (!preset) return;

            editingPresetName = presetName;
            document.getElementById('modal-title').textContent = 'Edit Preset';
            document.getElementById('modal-preset-name').value = presetName;
            document.getElementById('modal-text-color').value = preset.colors.text;
            document.getElementById('modal-label-color').value = preset.colors.label;
            document.getElementById('modal-border-color').value = preset.colors.border;
            document.getElementById('modal-border-width').value = preset.border?.width || 2;
            document.getElementById('modal-border-style').value = preset.border?.style || 'solid';
            document.getElementById('modal-border-radius').value = preset.border?.radius || 0;
            document.getElementById('modal-text-shadow').value = preset.textShadow || '2px 2px 4px rgba(0,0,0,0.8)';
            document.getElementById('modal-save-btn').textContent = 'Save Changes';

            updateModalPreview();
            document.getElementById('preset-modal').classList.add('active');
        }

        function openNewPresetModal() {
            editingPresetName = null;
            document.getElementById('modal-title').textContent = 'Create New Preset';
            document.getElementById('modal-preset-name').value = '';

            // Use current followers widget as base
            const widget = currentConfig.widgets.followers;
            document.getElementById('modal-text-color').value = widget.colors.text;
            document.getElementById('modal-label-color').value = widget.colors.label;
            document.getElementById('modal-border-color').value = widget.colors.border;
            document.getElementById('modal-border-width').value = widget.border.width;
            document.getElementById('modal-border-style').value = widget.border.style;
            document.getElementById('modal-border-radius').value = widget.border.radius;
            document.getElementById('modal-text-shadow').value = widget.textShadow || '2px 2px 4px rgba(0,0,0,0.8)';
            document.getElementById('modal-save-btn').textContent = 'Create Preset';

            updateModalPreview();
            document.getElementById('preset-modal').classList.add('active');
        }

        function closePresetModal() {
            document.getElementById('preset-modal').classList.remove('active');
            editingPresetName = null;
        }

        function updateModalPreview() {
            const textColor = document.getElementById('modal-text-color').value;
            const labelColor = document.getElementById('modal-label-color').value;
            const borderColor = document.getElementById('modal-border-color').value;
            const borderWidth = document.getElementById('modal-border-width').value;
            const borderStyle = document.getElementById('modal-border-style').value;
            const borderRadius = document.getElementById('modal-border-radius').value;
            let textShadow = document.getElementById('modal-text-shadow').value;

            // Replace currentColor with actual text color for preview
            if (textShadow.includes('currentColor')) {
                textShadow = textShadow.replace(/currentColor/g, textColor);
            }

            const box = document.getElementById('modal-preview-box');
            box.style.border = `${borderWidth}px ${borderStyle} ${borderColor}`;
            box.style.borderRadius = `${borderRadius}px`;
            box.querySelector('.preview-text').style.color = textColor;
            box.querySelector('.preview-text').style.textShadow = textShadow;
            box.querySelector('.preview-label').style.color = labelColor;
            box.querySelector('.preview-label').style.textShadow = textShadow;
        }

        function savePresetFromModal() {
            const name = document.getElementById('modal-preset-name').value.trim();

            if (!name) {
                showStatus('Please enter a preset name', false);
                return;
            }

            if (name.length > 20) {
                showStatus('Preset name must be 20 characters or less', false);
                return;
            }

            // Check if renaming would overwrite another preset
            if (editingPresetName && name !== editingPresetName && customPresets[name]) {
                showStatus(`A preset named "${name}" already exists`, false);
                return;
            }

            let textShadow = document.getElementById('modal-text-shadow').value;
            const textColor = document.getElementById('modal-text-color').value;
            // Store with currentColor for dynamic glow effects
            if (textShadow.includes('currentColor')) {
                // Keep as is - will be replaced when applied
            }

            const newPreset = {
                name: name,
                colors: {
                    text: textColor,
                    label: document.getElementById('modal-label-color').value,
                    border: document.getElementById('modal-border-color').value
                },
                border: {
                    width: parseInt(document.getElementById('modal-border-width').value) || 2,
                    style: document.getElementById('modal-border-style').value,
                    radius: parseInt(document.getElementById('modal-border-radius').value) || 0
                },
                textShadow: textShadow
            };

            // If renaming, delete the old one first
            if (editingPresetName && name !== editingPresetName) {
                delete customPresets[editingPresetName];
            }

            customPresets[name] = newPreset;
            saveCustomPresetsToStorage();
            renderPresetButtons();
            renderSavedPresetsList();
            closePresetModal();

            if (editingPresetName) {
                showStatus(`Preset "${name}" updated`, true);
            } else {
                showStatus(`Preset "${name}" created`, true);
            }
        }

        // Setup modal event listeners for live preview
        function setupModalListeners() {
            const inputs = [
                'modal-text-color', 'modal-label-color', 'modal-border-color',
                'modal-border-width', 'modal-border-style', 'modal-border-radius',
                'modal-text-shadow'
            ];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', updateModalPreview);
                    el.addEventListener('change', updateModalPreview);
                }
            });

            // Close modal on overlay click
            document.getElementById('preset-modal').addEventListener('click', (e) => {
                if (e.target.id === 'preset-modal') {
                    closePresetModal();
                }
            });

            // Close modal on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && document.getElementById('preset-modal').classList.contains('active')) {
                    closePresetModal();
                }
            });
        }

        function applyPresetToAllWidgets(presetName) {
            const preset = customPresets[presetName];
            if (!preset) return;

            widgets.forEach(widget => {
                applyPresetToWidget(widget, preset);
            });
            showStatus(`Applied "${presetName}" to all widgets`, true);
        }

        function deleteCustomPreset(name) {
            if (!confirm(`Delete preset "${name}"?`)) return;
            delete customPresets[name];
            saveCustomPresetsToStorage();
            renderPresetButtons();
            renderSavedPresetsList();
            showStatus(`Deleted preset "${name}"`, true);
        }

        // ========== Widget Groups Functions ==========
        let editingGroupId = null;
        let groupRotationTimers = {};

        function generateGroupId() {
            return 'group_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function openNewGroupModal() {
            editingGroupId = null;
            document.getElementById('group-modal-title').textContent = 'Create Widget Group';
            document.getElementById('group-name').value = '';
            document.getElementById('group-interval').value = '10';
            document.getElementById('group-animation').value = 'fade';
            document.getElementById('group-save-btn').textContent = 'Create Group';

            renderWidgetSelector([]);
            document.getElementById('group-modal').classList.add('active');
        }

        function openEditGroupModal(groupId) {
            const group = currentConfig.widgetGroups.find(g => g.id === groupId);
            if (!group) return;

            editingGroupId = groupId;
            document.getElementById('group-modal-title').textContent = 'Edit Widget Group';
            document.getElementById('group-name').value = group.name;
            document.getElementById('group-interval').value = group.interval.toString();
            document.getElementById('group-animation').value = group.animation;
            document.getElementById('group-save-btn').textContent = 'Save Changes';

            renderWidgetSelector(group.widgets);
            document.getElementById('group-modal').classList.add('active');
        }

        function closeGroupModal() {
            document.getElementById('group-modal').classList.remove('active');
            editingGroupId = null;
        }

        function renderWidgetSelector(selectedWidgets = []) {
            const container = document.getElementById('widget-selector');
            container.innerHTML = '';

            // Get widgets already in other groups (except the one being edited)
            const widgetsInOtherGroups = new Set();
            currentConfig.widgetGroups.forEach(group => {
                if (group.id !== editingGroupId) {
                    group.widgets.forEach(w => widgetsInOtherGroups.add(w));
                }
            });

            const widgetLabels = {
                followers: 'Followers',
                subgoal: 'Sub Goal',
                bits: 'Bits Today',
                hours: 'Hours Streamed',
                monthly: 'Monthly Artists',
                lifetime: 'Lifetime Artists'
            };

            widgets.forEach(widget => {
                const isInOtherGroup = widgetsInOtherGroups.has(widget);
                const isSelected = selectedWidgets.includes(widget);
                const isEnabled = currentConfig.widgets[widget]?.enabled !== false;

                const item = document.createElement('div');
                item.className = 'widget-selector-item' +
                    (isSelected ? ' selected' : '') +
                    (isInOtherGroup || !isEnabled ? ' disabled' : '');
                item.innerHTML = `
                    <input type="checkbox" value="${widget}"
                        ${isSelected ? 'checked' : ''}
                        ${isInOtherGroup || !isEnabled ? 'disabled' : ''}>
                    <span class="checkmark">âœ“</span>
                    <span class="widget-label">${widgetLabels[widget] || widget}</span>
                `;

                if (!isInOtherGroup && isEnabled) {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const checkbox = item.querySelector('input');
                        checkbox.checked = !checkbox.checked;
                        item.classList.toggle('selected', checkbox.checked);
                    });
                }

                if (isInOtherGroup) {
                    item.title = 'Already in another group';
                } else if (!isEnabled) {
                    item.title = 'Widget is disabled';
                }

                container.appendChild(item);
            });
        }

        function saveGroupFromModal() {
            const name = document.getElementById('group-name').value.trim();
            const interval = parseInt(document.getElementById('group-interval').value);
            const animation = document.getElementById('group-animation').value;

            // Get selected widgets
            const selectedWidgets = [];
            document.querySelectorAll('#widget-selector input:checked').forEach(cb => {
                selectedWidgets.push(cb.value);
            });

            if (!name) {
                showStatus('Please enter a group name', false);
                return;
            }

            if (selectedWidgets.length < 2) {
                showStatus('Please select at least 2 widgets to rotate', false);
                return;
            }

            if (editingGroupId) {
                // Update existing group
                const group = currentConfig.widgetGroups.find(g => g.id === editingGroupId);
                if (group) {
                    group.name = name;
                    group.widgets = selectedWidgets;
                    group.interval = interval;
                    group.animation = animation;
                }
                showStatus(`Group "${name}" updated`, true);
            } else {
                // Create new group
                const newGroup = {
                    id: generateGroupId(),
                    name: name,
                    widgets: selectedWidgets,
                    interval: interval,
                    animation: animation
                };
                currentConfig.widgetGroups.push(newGroup);
                showStatus(`Group "${name}" created`, true);
            }

            closeGroupModal();
            renderGroupList();
            renderPreviewWidgets();
            updatePreview();
            updateExportCode();
        }

        function deleteGroup(groupId) {
            const group = currentConfig.widgetGroups.find(g => g.id === groupId);
            if (!group) return;

            if (!confirm(`Delete group "${group.name}"?`)) return;

            currentConfig.widgetGroups = currentConfig.widgetGroups.filter(g => g.id !== groupId);

            // Stop any rotation timer for this group
            if (groupRotationTimers[groupId]) {
                clearInterval(groupRotationTimers[groupId]);
                delete groupRotationTimers[groupId];
            }

            renderGroupList();
            renderPreviewWidgets();
            updatePreview();
            updateExportCode();
            showStatus(`Group "${group.name}" deleted`, true);
        }

        function renderGroupList() {
            const container = document.getElementById('group-list');
            container.innerHTML = '';

            if (!currentConfig.widgetGroups || currentConfig.widgetGroups.length === 0) {
                container.innerHTML = '<div class="no-groups-message">No widget groups yet. Create one to rotate multiple widgets in one spot.</div>';
                return;
            }

            const widgetLabels = {
                followers: 'Followers',
                subgoal: 'Sub Goal',
                bits: 'Bits',
                hours: 'Hours',
                monthly: 'Monthly',
                lifetime: 'Lifetime'
            };

            currentConfig.widgetGroups.forEach(group => {
                const item = document.createElement('div');
                item.className = 'group-item';
                item.innerHTML = `
                    <div class="group-item-header">
                        <span class="group-item-name">${group.name}</span>
                        <div class="group-item-actions">
                            <button onclick="openEditGroupModal('${group.id}')">Edit</button>
                            <button onclick="deleteGroup('${group.id}')" style="color: #ff6b6b;">Delete</button>
                        </div>
                    </div>
                    <div class="group-item-widgets">
                        ${group.widgets.map(w => `<span class="group-widget-tag">${widgetLabels[w] || w}</span>`).join('')}
                    </div>
                    <div class="group-item-settings">
                        <span>â± ${group.interval}s rotation</span>
                        <span>âœ¨ ${group.animation} animation</span>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function getWidgetGroup(widgetId) {
            return currentConfig.widgetGroups?.find(g => g.widgets.includes(widgetId));
        }

        function isWidgetInAnyGroup(widgetId) {
            return currentConfig.widgetGroups?.some(g => g.widgets.includes(widgetId));
        }

        function startGroupRotations() {
            // Clear existing timers
            Object.keys(groupRotationTimers).forEach(id => {
                clearInterval(groupRotationTimers[id]);
            });
            groupRotationTimers = {};

            // Start new timers for each group
            currentConfig.widgetGroups?.forEach(group => {
                if (group.widgets.length < 2) return;

                let currentIndex = 0;
                const container = document.querySelector(`.preview-widget-group[data-group-id="${group.id}"]`);
                if (!container) return;

                // Set initial active widget
                const widgets = container.querySelectorAll('.preview-widget');
                widgets.forEach((w, i) => {
                    w.classList.toggle('group-active', i === 0);
                });

                // Start rotation
                groupRotationTimers[group.id] = setInterval(() => {
                    const widgets = container.querySelectorAll('.preview-widget');
                    if (widgets.length === 0) return;

                    widgets[currentIndex].classList.remove('group-active');
                    currentIndex = (currentIndex + 1) % widgets.length;
                    widgets[currentIndex].classList.add('group-active');
                }, group.interval * 1000);
            });
        }

        // Setup group modal event listeners
        function setupGroupModalListeners() {
            // Close modal on overlay click
            document.getElementById('group-modal').addEventListener('click', (e) => {
                if (e.target.id === 'group-modal') {
                    closeGroupModal();
                }
            });
        }

        function loadGoogleFont(fontName) {
            if (googleFonts.includes(fontName)) {
                const link = document.getElementById('google-font-link');
                const encodedFont = fontName.replace(/ /g, '+');
                link.href = `https://fonts.googleapis.com/css2?family=${encodedFont}:wght@400;700&display=swap`;
                document.getElementById('font-preview').style.fontFamily = `'${fontName}', sans-serif`;
            } else {
                document.getElementById('font-preview').style.fontFamily = fontName;
            }
        }

        function loadConfig() {
            try {
                const stored = localStorage.getItem('brandingConfig');
                if (stored) {
                    const parsed = JSON.parse(stored);

                    // Start with a fresh copy of defaults
                    currentConfig = JSON.parse(JSON.stringify(defaultConfig));

                    // Merge global settings (preserve user's choices)
                    if (parsed.fontFamily) currentConfig.fontFamily = parsed.fontFamily;
                    if (parsed.googleFont !== undefined) currentConfig.googleFont = parsed.googleFont;
                    if (parsed.layout) currentConfig.layout = { ...currentConfig.layout, ...parsed.layout };

                    // Handle widgetOrder carefully - preserve user order but add any new widgets
                    if (parsed.widgetOrder && Array.isArray(parsed.widgetOrder)) {
                        // Start with user's saved order
                        const mergedOrder = [...parsed.widgetOrder];

                        // Add any new widgets that aren't in the saved order (at the end)
                        defaultConfig.widgetOrder.forEach(widget => {
                            if (!mergedOrder.includes(widget)) {
                                mergedOrder.push(widget);
                                console.log(`Added new widget '${widget}' to your layout`);
                            }
                        });

                        // Remove any widgets that no longer exist in defaults
                        currentConfig.widgetOrder = mergedOrder.filter(w => defaultConfig.widgetOrder.includes(w));
                    }

                    // Deep merge each widget's settings
                    if (parsed.widgets) {
                        Object.keys(parsed.widgets).forEach(widget => {
                            if (currentConfig.widgets[widget]) {
                                const savedWidget = parsed.widgets[widget];
                                const defaultWidget = currentConfig.widgets[widget];

                                // Merge top-level widget properties
                                if (savedWidget.enabled !== undefined) defaultWidget.enabled = savedWidget.enabled;
                                if (savedWidget.fontSize !== undefined) defaultWidget.fontSize = savedWidget.fontSize;
                                if (savedWidget.labelFontSize !== undefined) defaultWidget.labelFontSize = savedWidget.labelFontSize;
                                if (savedWidget.labelGap !== undefined) defaultWidget.labelGap = savedWidget.labelGap;
                                if (savedWidget.textShadow !== undefined) defaultWidget.textShadow = savedWidget.textShadow;

                                // Deep merge nested objects (colors, border, background, padding)
                                if (savedWidget.colors) {
                                    defaultWidget.colors = { ...defaultWidget.colors, ...savedWidget.colors };
                                }
                                if (savedWidget.border) {
                                    defaultWidget.border = { ...defaultWidget.border, ...savedWidget.border };
                                }
                                if (savedWidget.background) {
                                    defaultWidget.background = { ...defaultWidget.background, ...savedWidget.background };
                                }
                                if (savedWidget.padding) {
                                    defaultWidget.padding = { ...defaultWidget.padding, ...savedWidget.padding };
                                }
                            }
                        });
                    }

                    // Load widget groups (for rotation feature)
                    if (parsed.widgetGroups && Array.isArray(parsed.widgetGroups)) {
                        currentConfig.widgetGroups = parsed.widgetGroups;
                    }

                    console.log('Loaded branding config from localStorage (merged with defaults)');
                }
            } catch (e) {
                console.error('Error loading config, using defaults:', e);
                currentConfig = JSON.parse(JSON.stringify(defaultConfig));
            }
            applyToControls();
        }

        function applyToControls() {
            document.getElementById('font-family').value = currentConfig.fontFamily;
            document.getElementById('gap').value = currentConfig.layout.gap;
            document.getElementById('gap-display').textContent = currentConfig.layout.gap;

            widgets.forEach(widget => {
                const w = currentConfig.widgets[widget];
                if (!w) return;

                // Enabled toggle
                const enabledEl = document.getElementById(`${widget}-enabled`);
                if (enabledEl) {
                    enabledEl.checked = w.enabled !== false;
                }

                // Colors
                setElementValue(`${widget}-text-color`, w.colors.text);
                setElementValue(`${widget}-text-color-picker`, w.colors.text);
                setElementValue(`${widget}-label-color`, w.colors.label);
                setElementValue(`${widget}-label-color-picker`, w.colors.label);
                setElementValue(`${widget}-border-color`, w.colors.border);
                setElementValue(`${widget}-border-color-picker`, w.colors.border);

                // Background
                setElementChecked(`${widget}-bg-enabled`, w.background.enabled);
                setElementValue(`${widget}-bg-color`, w.background.color);
                setElementValue(`${widget}-bg-color-picker`, rgbToHex(w.background.color) || '#000000');
                setElementDisplay(`${widget}-bg-color-group`, w.background.enabled ? 'block' : 'none');

                const opacity = w.background.opacity === undefined ? 30 : w.background.opacity;
                setElementValue(`${widget}-bg-opacity`, opacity);
                setElementText(`${widget}-bg-opacity-display`, opacity);

                // Font sizes
                setElementValue(`${widget}-font-size`, w.fontSize);
                setElementText(`${widget}-font-size-display`, w.fontSize);
                setElementValue(`${widget}-label-font-size`, w.labelFontSize);
                setElementText(`${widget}-label-font-size-display`, w.labelFontSize);

                // Label gap
                const labelGap = w.labelGap !== undefined ? w.labelGap : 5;
                setElementValue(`${widget}-label-gap`, labelGap);
                setElementText(`${widget}-label-gap-display`, labelGap);

                // Border
                setElementValue(`${widget}-border-width`, w.border.width);
                setElementText(`${widget}-border-width-display`, w.border.width);
                setElementValue(`${widget}-border-radius`, w.border.radius);
                setElementText(`${widget}-border-radius-display`, w.border.radius);

                // Padding
                setElementValue(`${widget}-padding-v`, w.padding.vertical);
                setElementText(`${widget}-padding-v-display`, w.padding.vertical);
                setElementValue(`${widget}-padding-h`, w.padding.horizontal);
                setElementText(`${widget}-padding-h-display`, w.padding.horizontal);

                // Text shadow buttons
                document.querySelectorAll(`.shadow-preset[data-widget="${widget}"]`).forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.shadow === (w.textShadow || '2px 2px 4px rgba(0,0,0,0.8)'));
                });

                // Border style buttons
                document.querySelectorAll(`.border-style-btn[data-widget="${widget}"]`).forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.style === w.border.style);
                });
            });
        }

        function setElementValue(id, value) {
            const el = document.getElementById(id);
            if (el) el.value = value;
        }

        function setElementText(id, value) {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        }

        function setElementChecked(id, value) {
            const el = document.getElementById(id);
            if (el) el.checked = value;
        }

        function setElementDisplay(id, value) {
            const el = document.getElementById(id);
            if (el) el.style.display = value;
        }

        function rgbToHex(rgba) {
            if (rgba && rgba.startsWith('#')) return rgba;
            const match = rgba.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
            if (match) {
                const r = parseInt(match[1]);
                const g = parseInt(match[2]);
                const b = parseInt(match[3]);
                return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
            }
            return null;
        }

        function toggleWidgetSection(widget) {
            const section = document.querySelector(`.widget-section[data-widget="${widget}"]`);
            if (section) {
                section.classList.toggle('collapsed');
            }
        }

        function toggleWidgetVisibility(widget) {
            const enabled = document.getElementById(`${widget}-enabled`).checked;
            currentConfig.widgets[widget].enabled = enabled;

            const section = document.querySelector(`.widget-section[data-widget="${widget}"]`);
            if (section) {
                section.classList.toggle('disabled', !enabled);
            }

            renderPreviewWidgets();
            updatePreview();
            updateExportCode();
        }

        function setupEventListeners() {
            // Global font
            document.getElementById('font-family').addEventListener('change', (e) => {
                currentConfig.fontFamily = e.target.value;
                currentConfig.googleFont = googleFonts.includes(e.target.value);
                loadGoogleFont(e.target.value);
                updatePreview();
                updateExportCode();
            });

            // Global gap
            document.getElementById('gap').addEventListener('input', (e) => {
                currentConfig.layout.gap = parseInt(e.target.value);
                document.getElementById('gap-display').textContent = e.target.value;
                updatePreview();
                updateExportCode();
            });

            // Widget-specific listeners
            widgets.forEach(widget => {
                setupWidgetListeners(widget);
            });

            // Shadow preset buttons
            document.querySelectorAll('.shadow-preset').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const widget = e.target.dataset.widget;
                    const shadow = e.target.dataset.shadow;
                    currentConfig.widgets[widget].textShadow = shadow;

                    document.querySelectorAll(`.shadow-preset[data-widget="${widget}"]`).forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');

                    updatePreview();
                    updateExportCode();
                });
            });

            // Border style buttons
            document.querySelectorAll('.border-style-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const widget = e.target.dataset.widget;
                    const style = e.target.dataset.style;
                    currentConfig.widgets[widget].border.style = style;

                    document.querySelectorAll(`.border-style-btn[data-widget="${widget}"]`).forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');

                    updatePreview();
                    updateExportCode();
                });
            });
        }

        function setupWidgetListeners(widget) {
            const w = currentConfig.widgets[widget];

            const colorFields = ['text-color', 'label-color', 'border-color'];
            colorFields.forEach(field => {
                const picker = document.getElementById(`${widget}-${field}-picker`);
                const text = document.getElementById(`${widget}-${field}`);
                const colorKey = field.replace('-color', '');

                if (picker) {
                    picker.addEventListener('input', (e) => {
                        if (text) text.value = e.target.value;
                        w.colors[colorKey] = e.target.value;
                        updatePreview();
                        updateExportCode();
                    });
                }

                if (text) {
                    text.addEventListener('input', (e) => {
                        if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) {
                            if (picker) picker.value = e.target.value;
                            w.colors[colorKey] = e.target.value;
                            updatePreview();
                            updateExportCode();
                        }
                    });
                }
            });

            const bgEnabled = document.getElementById(`${widget}-bg-enabled`);
            if (bgEnabled) {
                bgEnabled.addEventListener('change', (e) => {
                    w.background.enabled = e.target.checked;
                    document.getElementById(`${widget}-bg-color-group`).style.display = e.target.checked ? 'block' : 'none';
                    updatePreview();
                    updateExportCode();
                });
            }

            const bgColor = document.getElementById(`${widget}-bg-color`);
            if (bgColor) {
                bgColor.addEventListener('input', (e) => {
                    w.background.color = e.target.value;
                    updatePreview();
                    updateExportCode();
                });
            }

            const bgColorPicker = document.getElementById(`${widget}-bg-color-picker`);
            if (bgColorPicker) {
                bgColorPicker.addEventListener('input', (e) => {
                    const color = e.target.value;
                    document.getElementById(`${widget}-bg-color`).value = color;
                    w.background.color = color;
                    if (!w.background.opacity) w.background.opacity = 30;
                    updatePreview();
                    updateExportCode();
                });
            }

            const bgOpacity = document.getElementById(`${widget}-bg-opacity`);
            if (bgOpacity) {
                bgOpacity.addEventListener('input', (e) => {
                    w.background.opacity = parseInt(e.target.value);
                    document.getElementById(`${widget}-bg-opacity-display`).textContent = e.target.value;
                    updatePreview();
                    updateExportCode();
                });
            }

            const fontSize = document.getElementById(`${widget}-font-size`);
            if (fontSize) {
                fontSize.addEventListener('input', (e) => {
                    w.fontSize = parseInt(e.target.value);
                    document.getElementById(`${widget}-font-size-display`).textContent = e.target.value;
                    updatePreview();
                    updateExportCode();
                });
            }

            const labelFontSize = document.getElementById(`${widget}-label-font-size`);
            if (labelFontSize) {
                labelFontSize.addEventListener('input', (e) => {
                    w.labelFontSize = parseInt(e.target.value);
                    document.getElementById(`${widget}-label-font-size-display`).textContent = e.target.value;
                    updatePreview();
                    updateExportCode();
                });
            }

            const labelGap = document.getElementById(`${widget}-label-gap`);
            if (labelGap) {
                labelGap.addEventListener('input', (e) => {
                    w.labelGap = parseInt(e.target.value);
                    document.getElementById(`${widget}-label-gap-display`).textContent = e.target.value;
                    updatePreview();
                    updateExportCode();
                });
            }

            const borderWidth = document.getElementById(`${widget}-border-width`);
            if (borderWidth) {
                borderWidth.addEventListener('input', (e) => {
                    w.border.width = parseInt(e.target.value);
                    document.getElementById(`${widget}-border-width-display`).textContent = e.target.value;
                    updatePreview();
                    updateExportCode();
                });
            }

            const borderRadius = document.getElementById(`${widget}-border-radius`);
            if (borderRadius) {
                borderRadius.addEventListener('input', (e) => {
                    w.border.radius = parseInt(e.target.value);
                    document.getElementById(`${widget}-border-radius-display`).textContent = e.target.value;
                    updatePreview();
                    updateExportCode();
                });
            }

            const paddingV = document.getElementById(`${widget}-padding-v`);
            if (paddingV) {
                paddingV.addEventListener('input', (e) => {
                    w.padding.vertical = parseInt(e.target.value);
                    document.getElementById(`${widget}-padding-v-display`).textContent = e.target.value;
                    updatePreview();
                    updateExportCode();
                });
            }

            const paddingH = document.getElementById(`${widget}-padding-h`);
            if (paddingH) {
                paddingH.addEventListener('input', (e) => {
                    w.padding.horizontal = parseInt(e.target.value);
                    document.getElementById(`${widget}-padding-h-display`).textContent = e.target.value;
                    updatePreview();
                    updateExportCode();
                });
            }
        }

        function renderPreviewWidgets() {
            const container = document.getElementById('preview-container');
            container.innerHTML = '';

            // Track which widgets have been rendered (to avoid duplicates from groups)
            const renderedWidgets = new Set();

            currentConfig.widgetOrder.forEach(widget => {
                // Skip if already rendered (part of a group)
                if (renderedWidgets.has(widget)) return;

                const def = widgetDefs[widget];
                const config = currentConfig.widgets[widget];
                if (!def || !config) return;

                // Check if this widget is part of a group
                const group = getWidgetGroup(widget);

                if (group) {
                    // Render the entire group as a single container
                    const groupContainer = document.createElement('div');
                    groupContainer.className = `preview-widget-group ${group.animation}`;
                    groupContainer.dataset.groupId = group.id;

                    group.widgets.forEach((groupWidget, index) => {
                        renderedWidgets.add(groupWidget);
                        const gDef = widgetDefs[groupWidget];
                        const gConfig = currentConfig.widgets[groupWidget];
                        if (!gDef || !gConfig) return;

                        const div = document.createElement('div');
                        div.className = `preview-widget ${groupWidget}`;
                        div.dataset.widget = groupWidget;
                        // First widget in group is active by default
                        if (index === 0) {
                            div.classList.add('group-active');
                        }

                        if (gConfig.enabled === false) {
                            div.classList.add('hidden');
                        }

                        div.innerHTML = `
                            <div class="preview-label">${gDef.label}</div>
                            <div class="preview-value">${gDef.sampleValue}</div>
                        `;

                        groupContainer.appendChild(div);
                    });

                    // Add group indicator
                    const indicator = document.createElement('div');
                    indicator.className = 'group-indicator';
                    indicator.innerHTML = `<span>ðŸ”„ ${group.name} (${group.interval}s)</span>`;
                    groupContainer.appendChild(indicator);

                    container.appendChild(groupContainer);
                } else {
                    // Regular widget (not in a group)
                    const div = document.createElement('div');
                    div.className = `preview-widget ${widget}`;
                    div.dataset.widget = widget;
                    div.draggable = true;

                    if (config.enabled === false) {
                        div.classList.add('hidden');
                    }

                    div.innerHTML = `
                        <div class="preview-label">${def.label}</div>
                        <div class="preview-value">${def.sampleValue}</div>
                    `;

                    container.appendChild(div);
                    renderedWidgets.add(widget);
                }
            });

            setupDragAndDrop();
            startGroupRotations();
        }

        function setupDragAndDrop() {
            const container = document.getElementById('preview-container');
            const widgets = container.querySelectorAll('.preview-widget');

            widgets.forEach(widget => {
                widget.addEventListener('dragstart', handleDragStart);
                widget.addEventListener('dragend', handleDragEnd);
                widget.addEventListener('dragover', handleDragOver);
                widget.addEventListener('dragenter', handleDragEnter);
                widget.addEventListener('dragleave', handleDragLeave);
                widget.addEventListener('drop', handleDrop);
            });
        }

        function handleDragStart(e) {
            draggedWidget = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.widget);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.preview-widget').forEach(w => w.classList.remove('drag-over'));
            draggedWidget = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            if (this !== draggedWidget) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');

            if (draggedWidget && this !== draggedWidget) {
                const container = document.getElementById('preview-container');
                const allWidgets = Array.from(container.querySelectorAll('.preview-widget'));
                const draggedIndex = allWidgets.indexOf(draggedWidget);
                const dropIndex = allWidgets.indexOf(this);

                if (draggedIndex < dropIndex) {
                    this.parentNode.insertBefore(draggedWidget, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(draggedWidget, this);
                }

                // Update config order
                const newOrder = Array.from(container.querySelectorAll('.preview-widget')).map(w => w.dataset.widget);
                currentConfig.widgetOrder = newOrder;

                updateExportCode();
            }
        }

        function updatePreview() {
            const root = document.documentElement;

            root.style.setProperty('--preview-gap', currentConfig.layout.gap + 'px');
            root.style.setProperty('--preview-font-family', `'${currentConfig.fontFamily}', sans-serif`);

            widgets.forEach(widget => {
                const w = currentConfig.widgets[widget];
                if (!w) return;

                const prefix = `--${widget}`;

                root.style.setProperty(`${prefix}-text`, w.colors.text);
                root.style.setProperty(`${prefix}-label`, w.colors.label);
                root.style.setProperty(`${prefix}-border-color`, w.colors.border);

                if (w.background.enabled) {
                    const hex = rgbToHex(w.background.color) || '#000000';
                    const opacity = (w.background.opacity === 0 ? 0 : (w.background.opacity || 30)) / 100;
                    const r = parseInt(hex.slice(1, 3), 16);
                    const g = parseInt(hex.slice(3, 5), 16);
                    const b = parseInt(hex.slice(5, 7), 16);
                    root.style.setProperty(`${prefix}-bg`, `rgba(${r}, ${g}, ${b}, ${opacity})`);
                } else {
                    root.style.setProperty(`${prefix}-bg`, 'transparent');
                }

                root.style.setProperty(`${prefix}-size`, w.fontSize + 'px');
                root.style.setProperty(`${prefix}-label-size`, w.labelFontSize + 'px');
                root.style.setProperty(`${prefix}-label-gap`, (w.labelGap !== undefined ? w.labelGap : 5) + 'px');

                root.style.setProperty(`${prefix}-border-width`, w.border.width + 'px');
                root.style.setProperty(`${prefix}-border-style`, w.border.style);
                root.style.setProperty(`${prefix}-radius`, w.border.radius + 'px');

                root.style.setProperty(`${prefix}-padding`, `${w.padding.vertical}px ${w.padding.horizontal}px`);

                root.style.setProperty(`${prefix}-text-shadow`, w.textShadow || '2px 2px 4px rgba(0,0,0,0.8)');
            });
        }

        function updateExportCode() {
            const code = generateBrandingJS(currentConfig);
            document.getElementById('export-code').value = code;
        }

        function generateBrandingJS(config) {
            const widgetConfigs = widgets.map(widget => {
                const w = config.widgets[widget];
                return `        ${widget}: {
            enabled: ${w.enabled !== false},
            fontSize: ${w.fontSize},
            labelFontSize: ${w.labelFontSize},
            labelGap: ${w.labelGap !== undefined ? w.labelGap : 5},
            colors: {
                text: "${w.colors.text}",
                label: "${w.colors.label}",
                border: "${w.colors.border}",
                background: "${w.colors.background}"
            },
            border: {
                width: ${w.border.width},
                style: "${w.border.style}",
                radius: ${w.border.radius}
            },
            background: {
                enabled: ${w.background.enabled},
                color: "${w.background.color}",
                opacity: ${w.background.opacity || 30}
            },
            padding: {
                vertical: ${w.padding.vertical},
                horizontal: ${w.padding.horizontal}
            },
            textShadow: "${w.textShadow || '2px 2px 4px rgba(0,0,0,0.8)'}"
        }`;
            }).join(',\n');

            return `// Central Configuration for All Widgets
// Generated by Branding Settings
// Modular - Each widget has independent styling

const DEFAULT_CONFIG = {
    fontFamily: "${config.fontFamily}",
    googleFont: ${config.googleFont},
    fontWeight: "bold",
    textShadow: "2px 2px 4px rgba(0,0,0,0.8)",

    layout: {
        gap: ${config.layout.gap}
    },

    widgetOrder: ${JSON.stringify(config.widgetOrder)},

    widgetGroups: ${JSON.stringify(config.widgetGroups || [])},

    widgets: {
${widgetConfigs}
    }
};

let WIDGET_CONFIG = JSON.parse(JSON.stringify(DEFAULT_CONFIG));

function loadBrandingConfig() {
    try {
        const stored = localStorage.getItem('brandingConfig');
        if (stored) {
            const parsed = JSON.parse(stored);
            WIDGET_CONFIG = deepMerge(DEFAULT_CONFIG, parsed);
        }
    } catch (e) {
        WIDGET_CONFIG = JSON.parse(JSON.stringify(DEFAULT_CONFIG));
    }
}

function deepMerge(defaults, overrides) {
    const result = JSON.parse(JSON.stringify(defaults));
    for (const key in overrides) {
        if (overrides.hasOwnProperty(key)) {
            if (typeof overrides[key] === 'object' && overrides[key] !== null && !Array.isArray(overrides[key])) {
                result[key] = deepMerge(result[key] || {}, overrides[key]);
            } else {
                result[key] = overrides[key];
            }
        }
    }
    return result;
}

function loadGoogleFont(fontName) {
    if (WIDGET_CONFIG.googleFont && fontName) {
        const encodedFont = fontName.replace(/ /g, '+');
        const linkId = 'google-font-dynamic';
        let link = document.getElementById(linkId);
        if (!link) {
            link = document.createElement('link');
            link.id = linkId;
            link.rel = 'stylesheet';
            document.head.appendChild(link);
        }
        link.href = 'https://fonts.googleapis.com/css2?family=' + encodedFont + ':wght@400;700&display=swap';
    }
}

function applyWidgetStyles() {
    loadBrandingConfig();
    loadGoogleFont(WIDGET_CONFIG.fontFamily);

    const root = document.documentElement;

    root.style.setProperty('--font-family', WIDGET_CONFIG.fontFamily);
    root.style.setProperty('--font-weight', WIDGET_CONFIG.fontWeight);
    root.style.setProperty('--text-shadow', WIDGET_CONFIG.textShadow);
    root.style.setProperty('--gap', WIDGET_CONFIG.layout.gap + 'px');

    const widgets = ['followers', 'subgoal', 'bits', 'hours', 'monthly', 'lifetime'];

    widgets.forEach(widget => {
        const config = WIDGET_CONFIG.widgets[widget];
        if (!config) return;

        const prefix = '--widget-' + widget;

        root.style.setProperty(prefix + '-font-size', config.fontSize + 'px');
        root.style.setProperty(prefix + '-label-font-size', config.labelFontSize + 'px');
        root.style.setProperty(prefix + '-label-gap', (config.labelGap !== undefined ? config.labelGap : 5) + 'px');
        root.style.setProperty(prefix + '-text-color', config.colors.text);
        root.style.setProperty(prefix + '-label-color', config.colors.label);
        root.style.setProperty(prefix + '-border-color', config.colors.border);

        if (config.background && config.background.enabled) {
            const bgColor = config.background.color || '#000000';
            const opacity = config.background.opacity === undefined || config.background.opacity === null ? 30 : config.background.opacity;
            let hex = bgColor;
            if (bgColor.startsWith('rgba')) {
                const match = bgColor.match(/rgba?\\((\\d+),\\s*(\\d+),\\s*(\\d+)/);
                if (match) {
                    const r = parseInt(match[1]).toString(16).padStart(2, '0');
                    const g = parseInt(match[2]).toString(16).padStart(2, '0');
                    const b = parseInt(match[3]).toString(16).padStart(2, '0');
                    hex = '#' + r + g + b;
                }
            }
            const rgba = hexToRgba(hex, opacity);
            root.style.setProperty(prefix + '-bg-color', rgba);
        } else {
            root.style.setProperty(prefix + '-bg-color', 'transparent');
        }

        root.style.setProperty(prefix + '-border-width', (config.border ? config.border.width : 2) + 'px');
        root.style.setProperty(prefix + '-border-style', config.border ? config.border.style : 'solid');
        root.style.setProperty(prefix + '-border-radius', (config.border ? config.border.radius : 0) + 'px');
        root.style.setProperty(prefix + '-padding', config.padding
            ? (config.padding.vertical + 'px ' + config.padding.horizontal + 'px')
            : '8px 15px');

        root.style.setProperty(prefix + '-text-shadow', config.textShadow || WIDGET_CONFIG.textShadow || '2px 2px 4px rgba(0,0,0,0.8)');
    });
}

function getWidgetOrder() {
    return WIDGET_CONFIG.widgetOrder || ['followers', 'subgoal', 'bits', 'hours', 'monthly', 'lifetime'];
}

function isWidgetEnabled(widget) {
    return WIDGET_CONFIG.widgets[widget]?.enabled !== false;
}

document.addEventListener('DOMContentLoaded', applyWidgetStyles);`;
        }

        async function saveBranding() {
            try {
                // Create a backup before saving (keep last 3 backups)
                const existingConfig = localStorage.getItem('brandingConfig');
                if (existingConfig) {
                    const backups = JSON.parse(localStorage.getItem('brandingConfigBackups') || '[]');
                    backups.unshift({
                        timestamp: new Date().toISOString(),
                        config: existingConfig
                    });
                    // Keep only last 3 backups
                    while (backups.length > 3) backups.pop();
                    localStorage.setItem('brandingConfigBackups', JSON.stringify(backups));
                }

                localStorage.setItem('brandingConfig', JSON.stringify(currentConfig));

                const response = await fetch('/api/save-branding', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(currentConfig)
                });

                const result = await response.json();

                if (result.success) {
                    showStatus('Branding saved! (backup created)', true);
                } else {
                    showStatus('Saved to browser only. File update failed: ' + result.error, false);
                }
            } catch (e) {
                localStorage.setItem('brandingConfig', JSON.stringify(currentConfig));
                showStatus('Saved to browser only. Run "python twitch_stats.py" first.', false);
            }
        }

        function resetBranding() {
            // Create backup before reset
            const existingConfig = localStorage.getItem('brandingConfig');
            if (existingConfig) {
                const backups = JSON.parse(localStorage.getItem('brandingConfigBackups') || '[]');
                backups.unshift({
                    timestamp: new Date().toISOString(),
                    config: existingConfig,
                    note: 'Before reset'
                });
                while (backups.length > 3) backups.pop();
                localStorage.setItem('brandingConfigBackups', JSON.stringify(backups));
            }

            localStorage.removeItem('brandingConfig');
            currentConfig = JSON.parse(JSON.stringify(defaultConfig));
            applyToControls();
            loadGoogleFont(currentConfig.fontFamily);
            renderPreviewWidgets();
            renderPresetButtons();
            updatePreview();
            updateExportCode();
            showStatus('Reset to defaults (backup saved - use restoreBackup() in console to recover)', true);
        }

        function restoreBackup(index = 0) {
            // Can be called from browser console: restoreBackup() or restoreBackup(1)
            try {
                const backups = JSON.parse(localStorage.getItem('brandingConfigBackups') || '[]');
                if (backups.length === 0) {
                    console.log('No backups available');
                    return false;
                }
                if (index >= backups.length) {
                    console.log(`Only ${backups.length} backup(s) available. Use index 0-${backups.length - 1}`);
                    return false;
                }

                const backup = backups[index];
                console.log(`Restoring backup from: ${backup.timestamp}${backup.note ? ' (' + backup.note + ')' : ''}`);
                localStorage.setItem('brandingConfig', backup.config);
                location.reload();
                return true;
            } catch (e) {
                console.error('Failed to restore backup:', e);
                return false;
            }
        }

        function listBackups() {
            // Can be called from browser console to see available backups
            try {
                const backups = JSON.parse(localStorage.getItem('brandingConfigBackups') || '[]');
                if (backups.length === 0) {
                    console.log('No backups available');
                    return [];
                }
                console.log('Available backups:');
                backups.forEach((b, i) => {
                    console.log(`  [${i}] ${b.timestamp}${b.note ? ' - ' + b.note : ''}`);
                });
                console.log('\nTo restore: restoreBackup(index)');
                return backups;
            } catch (e) {
                console.error('Failed to list backups:', e);
                return [];
            }
        }

        // Make backup functions globally accessible from console
        window.restoreBackup = restoreBackup;
        window.listBackups = listBackups;

        function showStatus(message, success) {
            const el = document.getElementById('status-message');
            el.textContent = message;
            el.className = 'status-message ' + (success ? 'success' : 'error');
            setTimeout(() => {
                el.className = 'status-message';
            }, 5000);
        }

        function copyExportCode() {
            const textarea = document.getElementById('export-code');
            textarea.select();
            document.execCommand('copy');
            showStatus('Copied to clipboard!', true);
        }

        init();
    </script>
</body>
</html>
